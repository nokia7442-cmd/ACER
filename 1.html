<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coffee Tycoon - Advanced Staff Management</title>
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
        }
        .btn {
            @apply flex items-center justify-center px-6 py-3 rounded-xl font-bold text-lg text-white transition-all duration-300 transform hover:scale-105 shadow-lg;
        }
        .panel-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .panel-backdrop.show {
            opacity: 1;
        }
        .panel {
            background-color: #2D3748; /* Darker Slate-800 */
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            display: none;
            flex-direction: column;
            gap: 1rem;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .panel.show {
            display: flex;
            transform: scale(1);
            opacity: 1;
        }
        .message-box, .confirmation-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2D3748;
            color: #E2E8F0;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 200;
            text-align: center;
            display: none;
        }
        canvas {
            background-color: #1a202c; /* Deeper background for canvas */
        }
        /* New styles for menu cards */
        .menu-card {
            @apply bg-gray-700 rounded-xl p-4 shadow-lg flex flex-col items-center text-center transition-transform duration-200 hover:scale-105;
        }
        .menu-card-image {
            @apply w-24 h-24 bg-gray-500 rounded-full mb-3 flex items-center justify-center text-3xl text-gray-300;
        }
        .event-log-container {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        .event-log-container::-webkit-scrollbar {
            width: 8px;
        }
        .event-log-container::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        .event-log-container::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 10px;
            border: 2px solid #2d3748;
        }
    </style>
</head>
<body class="bg-gray-900 flex items-center justify-center min-h-screen p-4 md:p-8 text-gray-100">

    <div class="game-container bg-gray-800 rounded-3xl shadow-2xl p-6 md:p-12 w-full max-w-7xl">
        <h1 class="text-3xl md:text-5xl font-bold text-center text-teal-400 mb-6 drop-shadow-lg">Coffee Tycoon - Advanced Staff Management</h1>
        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Left Panel: Game Stats & Info -->
            <div class="w-full lg:w-1/3 bg-gray-700 p-8 rounded-2xl shadow-xl flex flex-col gap-6">
                <div class="flex justify-between items-center pb-4 border-b border-gray-600">
                    <span class="text-2xl font-semibold">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô</span>
                    <span id="money-display" class="text-3xl font-bold text-green-400">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="flex justify-between items-center pb-4 border-b border-gray-600">
                    <span class="text-2xl font-semibold">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</span>
                    <span id="day-display" class="text-3xl font-bold text-amber-400">0</span>
                </div>
                <div class="flex flex-col gap-2">
                    <span class="text-xl font-semibold text-gray-400">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                    <p class="text-sm">
                        ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏∂‡∏á‡∏û‡∏≠‡πÉ‡∏à‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span id="customer-satisfaction-display" class="text-green-300 font-bold">0%</span><br>
                        ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤: <span id="reputation-display" class="text-yellow-300 font-bold">0%</span><br>
                        ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô: <span id="loan-amount-display" class="text-red-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                    </p>
                </div>
                <div class="flex-grow flex flex-col justify-end">
                    <div class="p-4 bg-gray-600 rounded-lg shadow-inner text-sm text-gray-300 event-log-container">
                        <p class="font-bold mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
                        <div id="event-log-list">...‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô...</div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Menu Cards & Buttons -->
            <div class="w-full lg:w-2/3 flex flex-col gap-8">
                <!-- Canvas for visualization -->
                <canvas id="gameCanvas" class="w-full h-96 border-4 border-gray-600 rounded-lg mb-8"></canvas>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="menu-container">
                    <!-- Menu cards will be inserted here by JavaScript -->
                </div>
                
                <div class="buttons grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <button id="sell-all-btn" class="btn bg-gradient-to-br from-teal-500 to-green-600 hover:from-teal-600 hover:to-green-700 focus:outline-none focus:ring-2 focus:ring-green-400">
                        <i class="fas fa-mug-hot mr-2"></i>‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
                    </button>
                    <button id="buy-raw-btn" class="btn bg-gradient-to-br from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <i class="fas fa-shopping-basket mr-2"></i>‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö
                    </button>
                    <button id="buy-equipment-btn" class="btn bg-gradient-to-br from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 focus:outline-none focus:ring-2 focus:ring-orange-400">
                        <i class="fas fa-tools mr-2"></i>‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
                    </button>
                    <button id="set-price-btn" class="btn bg-gradient-to-br from-purple-500 to-fuchsia-600 hover:from-purple-600 hover:to-fuchsia-700 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <i class="fas fa-tags mr-2"></i>‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢
                    </button>
                    <button id="hire-staff-btn" class="btn bg-gradient-to-br from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                        <i class="fas fa-users mr-2"></i>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô
                    </button>
                    <button id="marketing-btn" class="btn bg-gradient-to-br from-sky-500 to-cyan-600 hover:from-sky-600 hover:to-cyan-700 focus:outline-none focus:ring-2 focus:ring-sky-400">
                        <i class="fas fa-bullhorn mr-2"></i>‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î
                    </button>
                    <button id="loan-btn" class="btn bg-gradient-to-br from-violet-500 to-purple-600 hover:from-violet-600 hover:to-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <i class="fas fa-hand-holding-usd mr-2"></i>‡∏Ç‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠
                    </button>
                    <button id="reports-btn" class="btn bg-gradient-to-br from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 focus:outline-none focus:ring-2 focus:ring-rose-400">
                        <i class="fas fa-chart-line mr-2"></i>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
                    </button>
                    <button id="research-btn" class="btn bg-gradient-to-br from-indigo-500 to-blue-600 hover:from-indigo-600 hover:to-blue-700 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                        <i class="fas fa-flask mr-2"></i>‡∏ß‡∏¥‡∏à‡∏±‡∏¢
                    </button>
                    <button id="next-day-btn" class="btn bg-gradient-to-br from-slate-500 to-gray-600 hover:from-slate-600 hover:to-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <i class="fas fa-sun mr-2"></i>‡πÑ‡∏õ‡∏ß‡∏±‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
                    </button>
                    <button id="save-game-btn" class="btn bg-gradient-to-br from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <i class="fas fa-save mr-2"></i>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°
                    </button>
                    <button id="load-game-btn" class="btn bg-gradient-to-br from-gray-500 to-gray-700 hover:from-gray-600 hover:to-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-400">
                        <i class="fas fa-folder-open mr-2"></i>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panels and Modals -->
    <div id="panel-backdrop" class="panel-backdrop">
        <!-- Panel for setting prices -->
        <div id="price-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÄ‡∏°‡∏ô‡∏π</h3>
            <label class="block mb-2">
                <span class="text-gray-200">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π:</span>
                <select id="menu-item-select" class="block w-full mt-1 p-2 bg-gray-700 border-gray-600 rounded-lg shadow-sm text-gray-100"></select>
            </label>
            <label class="block mb-4">
                <span class="text-gray-200">‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà:</span>
                <input type="number" id="new-price-input" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡∏°‡πà" class="block w-full mt-1 p-2 bg-gray-700 border-gray-600 rounded-lg shadow-sm text-gray-100">
            </label>
            <div class="flex justify-end gap-2">
                <button id="confirm-price-btn" class="btn bg-gradient-to-br from-teal-500 to-green-600"><i class="fas fa-check-circle mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button id="cancel-price-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times-circle mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>
        
        <!-- Panel for selling items (now mostly for info) -->
        <div id="sell-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <p class="text-gray-400">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô</p>
            <p class="text-gray-400">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡∏£‡πâ‡∏≠‡∏°</p>
            <div class="flex justify-end mt-4">
                <button id="cancel-sell-btn" class="btn bg-gradient-to-br from-gray-500 to-gray-700"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <!-- Panel for buying new raw materials -->
        <div id="buy-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</h3>
            <table class="min-w-full divide-y divide-gray-600">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠</th>
                    </tr>
                </thead>
                <tbody id="buy-item-table-body" class="bg-gray-800 divide-y divide-gray-600">
                    <!-- Table rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div class="flex justify-end gap-2 mt-4">
                <button id="pay-btn" class="btn bg-gradient-to-br from-blue-500 to-indigo-600"><i class="fas fa-credit-card mr-2"></i>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button id="cancel-buy-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <!-- Panel for buying new equipment -->
        <div id="equipment-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏ã‡∏∑‡πâ‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
            <table class="min-w-full divide-y divide-gray-600">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider"></th>
                    </tr>
                </thead>
                <tbody id="equipment-item-table-body" class="bg-gray-800 divide-y divide-gray-600">
                    <!-- Table rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button id="cancel-equipment-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <!-- Panel for hiring staff -->
        <div id="hire-staff-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</h3>
            <p class="text-gray-400">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="staff-count" class="font-bold text-teal-400">0</span> ‡∏Ñ‡∏ô</p>
            <button id="hire-new-staff-btn" class="btn bg-gradient-to-br from-emerald-500 to-teal-600 py-2 px-4 text-base mb-4"><i class="fas fa-user-plus mr-2"></i>‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            <table class="min-w-full divide-y divide-gray-600 mt-4">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏ó‡∏±‡∏Å‡∏©‡∏∞</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏Ç‡∏ß‡∏±‡∏ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="staff-table-body" class="bg-gray-800 divide-y divide-gray-600">
                    <!-- Table rows will be inserted here by JavaScript -->
                </tbody>
            </table>
            <div class="flex justify-end mt-4">
                <button id="cancel-staff-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <!-- Panel for marketing -->
        <div id="marketing-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î</h3>
            <p class="text-gray-400">‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-marketing-budget" class="font-bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-gray-400">‡∏á‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∏‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ:</p>
            <input type="range" id="marketing-slider" min="0" max="500" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-teal-400">
            <p class="text-lg font-bold text-center text-teal-400"><span id="marketing-budget-display">0</span> ‡∏ö‡∏≤‡∏ó</p>
            <div class="flex justify-end gap-2 mt-4">
                <button id="confirm-marketing-btn" class="btn bg-gradient-to-br from-teal-500 to-green-600"><i class="fas fa-check-circle mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
                <button id="cancel-marketing-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times-circle mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <!-- Panel for loan -->
        <div id="loan-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏Ç‡∏≠‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠</h3>
            <p class="text-gray-400">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="current-loan-amount" class="font-bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
            <p class="text-gray-400">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô: <span id="daily-loan-interest" class="font-bold">0</span> ‡∏ö‡∏≤‡∏ó</p>
            <label class="block mb-4">
                <span class="text-gray-200">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ:</span>
                <input type="number" id="loan-amount-input" placeholder="‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="block w-full mt-1 p-2 bg-gray-700 border-gray-600 rounded-lg shadow-sm text-gray-100">
            </label>
            <div class="flex justify-end gap-2 mt-4">
                <button id="request-loan-btn" class="btn bg-gradient-to-br from-violet-500 to-purple-600"><i class="fas fa-dollar-sign mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ</button>
                <button id="cancel-loan-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        </div>

        <!-- Panel for Reports -->
        <div id="reports-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h3>
            
            <h4 class="text-xl font-bold text-gray-200">‡∏á‡∏ö‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</h4>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex justify-between mb-1">
                    <span class="text-gray-400">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢:</span>
                    <span id="sales-revenue" class="text-green-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="flex justify-between mb-1">
                    <span class="text-gray-400">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö (COGS):</span>
                    <span id="cogs" class="text-red-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <hr class="border-gray-600 my-2">
                <div class="flex justify-between font-bold">
                    <span class="text-gray-200">‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô:</span>
                    <span id="gross-profit" class="text-green-400">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="flex justify-between mt-2 mb-1">
                    <span class="text-gray-400">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏á‡∏≤‡∏ô:</span>
                    <span id="operating-expenses" class="text-red-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <hr class="border-gray-600 my-2">
                <div class="flex justify-between font-bold">
                    <span class="text-gray-200">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                    <span id="net-profit" class="text-green-400">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>

            <h4 class="text-xl font-bold text-gray-200 mt-6">‡∏á‡∏ö‡∏î‡∏∏‡∏• (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</h4>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="flex justify-between mb-1">
                    <span class="text-gray-400">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î):</span>
                    <span id="assets-cash" class="text-teal-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="flex justify-between mb-1">
                    <span class="text-gray-400">‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå (‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö):</span>
                    <span id="assets-supplies" class="text-teal-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <hr class="border-gray-600 my-2">
                <div class="flex justify-between font-bold">
                    <span class="text-gray-200">‡∏£‡∏ß‡∏°‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå:</span>
                    <span id="total-assets" class="text-teal-400">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
                <div class="flex justify-between mt-2">
                    <span class="text-gray-400">‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô (‡∏™‡∏¥‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠):</span>
                    <span id="liabilities-loan" class="text-red-400 font-bold">0 ‡∏ö‡∏≤‡∏ó</span>
                </div>
            </div>
            
            <div class="flex justify-end mt-4">
                <button id="cancel-reports-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>

        <!-- Panel for Research and Development -->
        <div id="research-panel" class="panel">
            <h3 class="text-2xl font-bold mb-4 text-teal-400">‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏û‡∏±‡∏í‡∏ô‡∏≤</h3>
            <div id="research-project-list">
                <!-- Research projects will be inserted here by JavaScript -->
            </div>
            <div class="flex justify-end mt-4">
                <button id="cancel-research-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600"><i class="fas fa-times mr-2"></i>‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
        
    </div>

    <!-- Message Box -->
    <div id="message-box" class="message-box">
        <p id="message-text" class="mb-4 text-gray-100"></p>
        <button id="close-message-btn" class="btn bg-gradient-to-br from-teal-500 to-green-600"><i class="fas fa-check-circle mr-2"></i>‡∏ï‡∏Å‡∏•‡∏á</button>
    </div>

    <!-- Confirmation Box (New) -->
    <div id="confirmation-box" class="confirmation-box">
        <p id="confirmation-text" class="mb-4 text-gray-100"></p>
        <div class="flex justify-center gap-4">
            <button id="confirm-yes-btn" class="btn bg-gradient-to-br from-teal-500 to-green-600 px-4 py-2 text-base">
                <i class="fas fa-check mr-2"></i>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
            <button id="confirm-no-btn" class="btn bg-gradient-to-br from-red-500 to-rose-600 px-4 py-2 text-base">
                <i class="fas fa-times mr-2"></i>‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
        </div>
    </div>


    <script>
        // DOM element references
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const menuContainer = document.getElementById('menu-container');

        // Game state and data definitions
        const availableEquipment = [
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Basic)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ', cost: 1000 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Premium)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ', cost: 2500 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Basic)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô', cost: 5000 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Premium)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô', cost: 12000 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Basic)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô', cost: 2000 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Super)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô', cost: 4500 },
            { name: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Basic)', type: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö', cost: 3000 },
            { name: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Pro)', type: '‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö', cost: 7000 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Home)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', cost: 1500 },
            { name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Industrial)', type: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', cost: 6000 }
        ];
        
        const initialMenuRecipes = [
            {
                name: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏≥',
                ingredients: [{ name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≤‡∏£‡∏≤‡∏ö‡∏¥‡∏Å‡πâ‡∏≤', quantity: 1 }],
                equipment: ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ'],
                icon: '<i class="fas fa-coffee"></i>',
                baseCost: 50
            },
            {
                name: '‡∏•‡∏≤‡πÄ‡∏ï‡πâ‡∏£‡πâ‡∏≠‡∏ô',
                ingredients: [{ name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≤‡∏£‡∏≤‡∏ö‡∏¥‡∏Å‡πâ‡∏≤', quantity: 1 }, { name: '‡∏ô‡∏°‡∏™‡∏î', quantity: 1 }],
                equipment: ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô'],
                icon: '<i class="fas fa-mug-hot"></i>',
                baseCost: 70
            },
            {
                name: '‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô‡πÄ‡∏¢‡πá‡∏ô',
                ingredients: [{ name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡πÇ‡∏£‡∏ö‡∏±‡∏™‡∏ï‡πâ‡∏≤', quantity: 1 }, { name: '‡∏ô‡∏°‡∏™‡∏î', quantity: 1 }],
                equipment: ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô'],
                icon: '<i class="fas fa-ice-cream"></i>',
                baseCost: 85
            },
            {
                name: '‡πÄ‡∏Ñ‡πâ‡∏Å‡∏ä‡πá‡∏≠‡∏Å‡πÇ‡∏Å‡πÅ‡∏•‡∏ï',
                ingredients: [{ name: '‡πÅ‡∏õ‡πâ‡∏á', quantity: 1 }, { name: '‡πÇ‡∏Å‡πÇ‡∏Å‡πâ', quantity: 1 }],
                equipment: ['‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö'],
                icon: '<i class="fas fa-birthday-cake"></i>',
                baseCost: 60
            },
            {
                name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á‡πÄ‡∏ô‡∏¢‡∏™‡∏î',
                ingredients: [{ name: '‡πÅ‡∏õ‡πâ‡∏á', quantity: 1 }, { name: '‡πÄ‡∏ô‡∏¢', quantity: 1 }],
                equipment: ['‡πÄ‡∏ï‡∏≤‡∏≠‡∏ö', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏≥‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á'],
                icon: '<i class="fas fa-bread-slice"></i>',
                baseCost: 45
            }
        ];

        let buyableProducts = [
            { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≤‡∏£‡∏≤‡∏ö‡∏¥‡∏Å‡πâ‡∏≤', baseCost: 40, quality: 0.8 },
            { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡πÇ‡∏£‡∏ö‡∏±‡∏™‡∏ï‡πâ‡∏≤', baseCost: 30, quality: 0.7 },
            { name: '‡∏ô‡∏°‡∏™‡∏î', baseCost: 20, quality: 0.9 },
            { name: '‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•', baseCost: 10, quality: 0.95 },
            { name: '‡πÇ‡∏Å‡πÇ‡∏Å‡πâ', baseCost: 25, quality: 0.85 },
            { name: '‡πÅ‡∏õ‡πâ‡∏á', baseCost: 15, quality: 0.9 },
            { name: '‡πÄ‡∏ô‡∏¢', baseCost: 20, quality: 0.85 }
        ];

        // --- Customer Types (No changes here, but good to have) ---
        const customerTypes = [
            { name: "‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤", probability: 0.4, spendingPower: 0.6, preference: ["‡πÄ‡∏¢‡πá‡∏ô", "‡∏Ç‡∏ô‡∏°", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å"] },
            { name: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≠‡∏ü‡∏ü‡∏¥‡∏®", probability: 0.5, spendingPower: 1.2, preference: ["‡∏Å‡∏≤‡πÅ‡∏ü", "‡∏£‡πâ‡∏≠‡∏ô", "‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß"] },
            { name: "‡∏ô‡∏±‡∏Å‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß", probability: 0.1, spendingPower: 1.5, preference: ["‡∏Ç‡∏≠‡∏á‡∏î‡∏µ", "‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏Ñ‡∏£"] }
        ];

        // --- New: R&D Projects for Staff Training ---
        const researchProjects = [
            { 
                name: "‡∏Å‡∏≤‡πÅ‡∏ü‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏¢‡πá‡∏ô‡∏™‡∏π‡∏ï‡∏£‡∏•‡∏±‡∏ö",
                cost: 5000, 
                daysToComplete: 5,
                unlocked: false,
                icon: '<i class="fas fa-mortar-pestle"></i>',
                effect: { 
                    type: "unlock_menu", 
                    menuItem: {
                        name: '‡∏Å‡∏≤‡πÅ‡∏ü‡∏™‡∏Å‡∏±‡∏î‡πÄ‡∏¢‡πá‡∏ô',
                        ingredients: [{ name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≤‡∏£‡∏≤‡∏ö‡∏¥‡∏Å‡πâ‡∏≤', quantity: 2 }],
                        equipment: ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ'],
                        icon: '<i class="fas fa-glass-martini"></i>',
                        baseCost: 100,
                        tags: ["‡πÄ‡∏¢‡πá‡∏ô", "‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡πÉ‡∏Ñ‡∏£"]
                    }
                }
            },
            {
                name: "‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î)",
                cost: 2000,
                daysToComplete: 3,
                unlocked: false,
                icon: '<i class="fas fa-user-graduate"></i>',
                effect: {
                    type: "staff_skill_up",
                    skill: "marketing",
                    increase: 0.1
                }
            },
            {
                name: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ö‡∏≤‡∏£‡∏¥‡∏™‡∏ï‡πâ‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á",
                cost: 4000,
                daysToComplete: 7,
                unlocked: false,
                icon: '<i class="fas fa-award"></i>',
                effect: {
                    type: "unlock_training",
                    skillToTrain: "barista",
                    trainingCost: 1000
                }
            },
            {
                name: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á",
                cost: 4000,
                daysToComplete: 7,
                unlocked: false,
                icon: '<i class="fas fa-handshake"></i>',
                effect: {
                    type: "unlock_training",
                    skillToTrain: "service",
                    trainingCost: 1000
                }
            },
            {
                name: "‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
                cost: 4000,
                daysToComplete: 7,
                unlocked: false,
                icon: '<i class="fas fa-tachometer-alt"></i>',
                effect: {
                    type: "unlock_training",
                    skillToTrain: "speed",
                    trainingCost: 1000
                }
            }
        ];
        
        // --- Add Events to the game ---
        const gameEvents = [
            { name: "‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß", description: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏¢‡∏≤‡∏ß!", effect: { customerMultiplier: 1.5, supplierPriceChange: 0 }, duration: 3, probability: 0.1 },
            { name: "‡πÄ‡∏ó‡∏®‡∏Å‡∏≤‡∏•‡∏Å‡∏≤‡πÅ‡∏ü", description: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏Å‡∏≤‡πÅ‡∏ü‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô!", effect: { customerMultiplier: 1.2, supplierPriceChange: 0 }, duration: 5, probability: 0.05 },
            { name: "‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô", description: "‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏™‡∏π‡∏á‡∏Ç‡∏∂‡πâ‡∏ô!", effect: { customerMultiplier: 0.8, supplierPriceChange: 0.2 }, duration: 2, probability: 0.05 },
            { name: "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏£‡πâ‡∏≠‡∏ô‡∏à‡∏±‡∏î", description: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏î‡∏∑‡πà‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°‡πÄ‡∏¢‡πá‡∏ô‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô!", effect: { coldDrinkMultiplier: 1.5, hotDrinkMultiplier: 0.5 }, duration: 1, probability: 0.2 },
            { name: "‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏î‡∏µ", description: "‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏•‡∏∑‡∏≠‡∏î‡πâ‡∏≤‡∏ô‡∏•‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏Å‡∏ï‡πà‡∏≥!", effect: { reputationChange: -0.1 }, duration: 2, probability: 0.03 },
            { name: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", description: "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏Å‡∏ï‡∏¥", effect: {}, duration: 1, probability: 0.5 }
        ];

        const initialGameState = {
            player: {
                money: 5000,
                day: 1,
                daysInMonth: 1,
                lastEvent: "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Coffee Tycoon!",
                eventLog: ["‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà Coffee Tycoon!"],
                dailyRent: 200,
                loan: {
                    amount: 0,
                    interestRate: 0.05,
                    dailyInterest: 0
                },
                finances: {
                    salesRevenue: 0,
                    cogs: 0,
                    operatingExpenses: 0,
                    grossProfit: 0,
                    netProfit: 0,
                    totalAssets: 0,
                    inventoryValue: 0
                }
            },
            shop: {
                inventory: [
                    { name: '‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡∏≤‡πÅ‡∏ü‡∏≠‡∏≤‡∏£‡∏≤‡∏ö‡∏¥‡∏Å‡πâ‡∏≤', stock: 10, cost: 45, quality: 0.8 },
                    { name: '‡∏ô‡∏°‡∏™‡∏î', stock: 5, cost: 20, quality: 0.9 },
                    { name: '‡πÅ‡∏õ‡πâ‡∏á', stock: 0, cost: 10, quality: 0.9 }
                ],
                equipment: [{ name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏á‡∏Å‡∏≤‡πÅ‡∏ü‡∏î‡∏£‡∏¥‡∏õ (‡∏¢‡∏µ‡πà‡∏´‡πâ‡∏≠ Basic)' }],
                menu: initialMenuRecipes.map(item => ({...item, price: item.baseCost + 20})),
                marketingBudget: 0,
                customerSatisfaction: 0.5,
                reputation: 0.5 // New: Reputation score
            },
            // --- New: Staff structure with multiple skills ---
            employees: [
                { name: '‡∏ö‡∏≤‡∏£‡∏¥‡∏™‡∏ï‡πâ‡∏≤‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', wage: 10000, skills: { barista: 0.5, speed: 0.6, service: 0.7, marketing: 0.2 }, morale: 0.9 }
            ],
            staffForHire: [
                { name: '‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡πÄ‡∏Å‡πà‡∏á', wage: 15000, skills: { barista: 0.4, speed: 0.8, service: 0.9, marketing: 0.5 }, morale: 0.8 },
                { name: '‡πÄ‡∏ä‡∏ü‡∏Ç‡∏ô‡∏°‡∏´‡∏ß‡∏≤‡∏ô', wage: 12000, skills: { barista: 0.2, speed: 0.5, service: 0.8, marketing: 0.1 }, morale: 0.95 }
            ],
            // --- New: Training system state ---
            training: {
                // Initialize with unlocked skills. 'marketing' skill is now part of the base employee skills.
                availableSkills: ['barista', 'service', 'speed'], 
                activeTraining: null,
                daysRemaining: 0
            },
            currentEvent: null, // New: To hold the active event
            eventDuration: 0,
            research: {
                projects: researchProjects.map(p => ({ ...p })), // Deep copy
                activeProject: null,
                daysRemaining: 0
            }
        };

        let gameState = { ...initialGameState };
        let currentSupplierPrices = getSupplierPrices();

        // UI element references
        const panelBackdrop = document.getElementById('panel-backdrop');
        const pricePanel = document.getElementById('price-panel');
        const menuItemSelect = document.getElementById('menu-item-select');
        const newPriceInput = document.getElementById('new-price-input');
        const confirmPriceBtn = document.getElementById('confirm-price-btn');
        const cancelPriceBtn = document.getElementById('cancel-price-btn');

        const sellPanel = document.getElementById('sell-panel');
        const cancelSellBtn = document.getElementById('cancel-sell-btn');

        const buyPanel = document.getElementById('buy-panel');
        const buyItemTableBody = document.getElementById('buy-item-table-body');
        const cancelBuyBtn = document.getElementById('cancel-buy-btn');
        const payBtn = document.getElementById('pay-btn');
        
        const equipmentPanel = document.getElementById('equipment-panel');
        const equipmentItemTableBody = document.getElementById('equipment-item-table-body');
        const cancelEquipmentBtn = document.getElementById('cancel-equipment-btn');

        const hireStaffPanel = document.getElementById('hire-staff-panel');
        const staffTableBody = document.getElementById('staff-table-body');
        const cancelStaffBtn = document.getElementById('cancel-staff-btn');
        const hireNewStaffBtn = document.getElementById('hire-new-staff-btn');

        const marketingPanel = document.getElementById('marketing-panel');
        const marketingSlider = document.getElementById('marketing-slider');
        const marketingBudgetDisplay = document.getElementById('marketing-budget-display');
        const currentMarketingBudget = document.getElementById('current-marketing-budget');
        const confirmMarketingBtn = document.getElementById('confirm-marketing-btn');
        const cancelMarketingBtn = document.getElementById('cancel-marketing-btn');
        
        const loanPanel = document.getElementById('loan-panel');
        const currentLoanAmount = document.getElementById('current-loan-amount');
        const dailyLoanInterest = document.getElementById('daily-loan-interest');
        const loanAmountInput = document.getElementById('loan-amount-input');
        const requestLoanBtn = document.getElementById('request-loan-btn');
        const cancelLoanBtn = document.getElementById('cancel-loan-btn');

        const reportsPanel = document.getElementById('reports-panel');
        const cancelReportsBtn = document.getElementById('cancel-reports-btn');

        const researchPanel = document.getElementById('research-panel');
        const researchProjectList = document.getElementById('research-project-list');
        const cancelResearchBtn = document.getElementById('cancel-research-btn');


        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBoxBtn = document.getElementById('close-message-btn');

        // New Confirmation Box Elements
        const confirmationBox = document.getElementById('confirmation-box');
        const confirmationText = document.getElementById('confirmation-text');
        const confirmYesBtn = document.getElementById('confirm-yes-btn');
        const confirmNoBtn = document.getElementById('confirm-no-btn');

        // Main game display elements
        const moneyDisplay = document.getElementById('money-display');
        const dayDisplay = document.getElementById('day-display');
        const customerSatisfactionDisplay = document.getElementById('customer-satisfaction-display');
        const reputationDisplay = document.getElementById('reputation-display'); // New UI for reputation
        const loanAmountDisplay = document.getElementById('loan-amount-display');
        const eventLogList = document.getElementById('event-log-list');

        function updateUI() {
            moneyDisplay.textContent = `${gameState.player.money.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            dayDisplay.textContent = `${gameState.player.day} (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${gameState.player.daysInMonth} ‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)`;
            customerSatisfactionDisplay.textContent = `${(gameState.shop.customerSatisfaction * 100).toFixed(0)}%`;
            reputationDisplay.textContent = `${(gameState.shop.reputation * 100).toFixed(0)}%`;
            loanAmountDisplay.textContent = `${gameState.player.loan.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            
            // Update event log
            eventLogList.innerHTML = '';
            gameState.player.eventLog.slice(-5).forEach(log => {
                const p = document.createElement('p');
                p.textContent = log;
                p.className = 'my-1';
                eventLogList.appendChild(p);
            });

            // Update menu cards
            renderMenuCards();
        }

        function renderMenuCards() {
            menuContainer.innerHTML = '';
            gameState.shop.menu.forEach(item => {
                const canMake = canMakeMenuItem(item);
                const card = document.createElement('div');
                card.className = `menu-card ${canMake ? 'bg-gray-700' : 'bg-red-900 opacity-50'}`;
                card.innerHTML = `
                    <div class="menu-card-image">
                        ${item.icon}
                    </div>
                    <h4 class="text-xl font-bold text-teal-400 mt-2">${item.name}</h4>
                    <p class="text-gray-300">‡∏£‡∏≤‡∏Ñ‡∏≤: ${item.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                    <p class="text-sm ${canMake ? 'text-green-400' : 'text-red-400'}">
                        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${canMake ? '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢' : '‡∏Ç‡∏≤‡∏î‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö/‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'}
                    </p>
                `;
                menuContainer.appendChild(card);
            });
        }

        function showPanel(panel) {
            panelBackdrop.style.display = 'flex';
            setTimeout(() => {
                panelBackdrop.classList.add('show');
                panel.classList.add('show');
            }, 10);
        }

        function hidePanel(panel) {
            panel.classList.remove('show');
            panelBackdrop.classList.remove('show');
            setTimeout(() => {
                panelBackdrop.style.display = 'none';
            }, 300);
        }

        function showMessage(text) {
            messageText.textContent = text;
            messageBox.style.display = 'block';
        }

        function showConfirmation(text, onConfirm) {
            confirmationText.textContent = text;
            confirmationBox.style.display = 'block';
            
            const handleYes = () => {
                onConfirm();
                hideConfirmation();
                confirmYesBtn.removeEventListener('click', handleYes);
            };
            
            const handleNo = () => {
                hideConfirmation();
                confirmNoBtn.removeEventListener('click', handleNo);
            };

            confirmYesBtn.addEventListener('click', handleYes);
            confirmNoBtn.addEventListener('click', handleNo);
        }

        function hideConfirmation() {
            confirmationBox.style.display = 'none';
        }

        closeMessageBoxBtn.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });

        // Save game function
        function saveGame() {
            try {
                localStorage.setItem('coffeeTycoonSave_AdvancedStaff_v6', JSON.stringify(gameState));
                gameState.player.eventLog.push("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
            } catch (e) {
                gameState.player.eventLog.push("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡∏°: " + e.message);
            }
            updateUI();
        }

        // Load game function
        function loadGame() {
            try {
                const savedState = localStorage.getItem('coffeeTycoonSave_AdvancedStaff_v6');
                if (savedState) {
                    gameState = JSON.parse(savedState);
                    gameState.player.eventLog.push("‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
                } else {
                    gameState = JSON.parse(JSON.stringify(initialGameState));
                    gameState.player.eventLog.push("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà!");
                }
            } catch (e) {
                gameState.player.eventLog.push("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°: " + e.message);
                gameState = JSON.parse(JSON.stringify(initialGameState));
            }
            updateUI();
        }

        // Get supplier prices with slight fluctuation
        function getSupplierPrices() {
            let prices = {};
            buyableProducts.forEach(product => {
                const priceFluctuation = (Math.random() - 0.5) * 0.2; // +/- 10%
                let cost = Math.round(product.baseCost * (1 + priceFluctuation));
                // Apply event-based price change
                if (gameState.currentEvent && gameState.currentEvent.effect.supplierPriceChange) {
                    cost *= (1 + gameState.currentEvent.effect.supplierPriceChange);
                }
                prices[product.name] = { price: Math.max(10, cost), quality: product.quality };
            });
            return prices;
        }

        function buyItem(productName, cost, quantity, quality) {
            let existingItem = gameState.shop.inventory.find(item => item.name === productName);
            if (existingItem) {
                const totalQuantity = existingItem.stock + quantity;
                existingItem.quality = ((existingItem.quality * existingItem.stock) + (quality * quantity)) / totalQuantity;
                existingItem.stock += quantity;
            } else {
                gameState.shop.inventory.push({ name: productName, stock: quantity, cost: cost, quality: quality });
            }
            gameState.player.money -= cost * quantity;
        }

        function buyEquipment(equipmentName) {
            const eqToBuy = availableEquipment.find(eq => eq.name === equipmentName);
            if (!eqToBuy) { return; }
            if (gameState.player.money < eqToBuy.cost) {
                showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
                return;
            }
            const existingEq = gameState.shop.equipment.some(eq => eq.name === equipmentName);
            if(existingEq) {
                showMessage("‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ä‡∏¥‡πâ‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
                return;
            }
            
            gameState.player.money -= eqToBuy.cost;
            gameState.shop.equipment.push({ name: equipmentName });
            gameState.player.eventLog.push(`üéâ ‡∏ã‡∏∑‡πâ‡∏≠ ${eqToBuy.name} ‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${eqToBuy.cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
            updateUI();
            hidePanel(equipmentPanel);
        }

        // --- New: Hire Staff function with new skill structure ---
        function hireStaff() {
            if (gameState.staffForHire.length === 0) {
                showMessage("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");
                return;
            }
            const staffForHire = gameState.staffForHire.shift();
            if (gameState.player.money < staffForHire.wage) {
                showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å!");
                return;
            }
            gameState.player.money -= staffForHire.wage;
            gameState.employees.push(staffForHire);
            gameState.player.eventLog.push(`üéâ ‡∏à‡πâ‡∏≤‡∏á ${staffForHire.name} ‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${staffForHire.wage.toLocaleString()} ‡∏ö‡∏≤‡∏ó/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô`);
            updateUI();
            renderStaffPanel(); // Refresh panel
        }
        
        function fireStaff(staffName) {
            const index = gameState.employees.findIndex(emp => emp.name === staffName);
            if (index > -1) {
                const firedStaff = gameState.employees.splice(index, 1)[0];
                gameState.staffForHire.push(firedStaff); // Put them back in the pool
                gameState.player.eventLog.push(`üíî ‡πÑ‡∏•‡πà ${firedStaff.name} ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏á‡∏≤‡∏ô`);
                renderStaffPanel();
                updateUI();
            }
        }
        
        // --- Modified: Training function for specific skills ---
        function trainStaff(staffName, skillToTrain) {
            const staffToTrain = gameState.employees.find(emp => emp.name === staffName);
            if (!staffToTrain) return;

            const trainingCost = 2000;
            const trainingDuration = 3;
            
            // Check if the skill is available for training via research
            const isSkillUnlocked = gameState.research.projects.some(p => 
                p.effect?.type === "unlock_training" && p.effect?.skillToTrain === skillToTrain && p.unlocked
            );
            
            // Allow training on the default skills
            if (!isSkillUnlocked && !['barista', 'service', 'speed'].includes(skillToTrain)) {
                 showMessage("‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏ô‡∏µ‡πâ!");
                 return;
            }

            if (gameState.player.money < trainingCost) {
                showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°!");
                return;
            }
            if (gameState.training.activeTraining) {
                showMessage("‡∏°‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô!");
                return;
            }

            gameState.player.money -= trainingCost;
            gameState.training.activeTraining = { staffName, skillToTrain };
            gameState.training.daysRemaining = trainingDuration;

            gameState.player.eventLog.push(`üìö ${staffToTrain.name} ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡πÉ‡∏ô‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ${getThaiSkill(skillToTrain)}! ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ${trainingDuration} ‡∏ß‡∏±‡∏ô.`);
            renderStaffPanel();
            updateUI();
        }

        function giveBonus(staffName) {
            const staff = gameState.employees.find(emp => emp.name === staffName);
            const bonusCost = 500;
            if (staff && gameState.player.money >= bonusCost) {
                gameState.player.money -= bonusCost;
                staff.morale = Math.min(1, staff.morale + 0.1);
                gameState.player.eventLog.push(`üéâ ‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡πÉ‡∏´‡πâ ${staff.name} ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏ß‡∏±‡∏ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!`);
                renderStaffPanel();
                updateUI();
            } else {
                showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏à‡πà‡∏≤‡∏¢‡πÇ‡∏ö‡∏ô‡∏±‡∏™!");
            }
        }
        
        function canMakeMenuItem(menuItem) {
            const hasRequiredEquipment = menuItem.equipment.every(eqType => 
                gameState.shop.equipment.some(playerEq => playerEq.name.includes(eqType))
            );
            if (!hasRequiredEquipment) {
                return false;
            }
            return menuItem.ingredients.every(requiredIngredient => {
                const availableIngredient = gameState.shop.inventory.find(inv => inv.name === requiredIngredient.name);
                return availableIngredient && availableIngredient.stock >= requiredIngredient.quantity;
            });
        }

        function getCustomerType() {
            const rand = Math.random();
            let cumulativeProbability = 0;
            for (const customer of customerTypes) {
                cumulativeProbability += customer.probability;
                if (rand < cumulativeProbability) {
                    return customer;
                }
            }
            return customerTypes[0];
        }

        // --- Modified: sellMenuItem to use staff skills ---
        function sellMenuItem(itemName) {
            const itemToSell = gameState.shop.menu.find(item => item.name === itemName);
            if (!itemToSell) { return; }

            let cogsForThisItem = 0;
            itemToSell.ingredients.forEach(ingredient => {
                const invItem = gameState.shop.inventory.find(inv => inv.name === ingredient.name);
                if (invItem) {
                    cogsForThisItem += invItem.cost * ingredient.quantity;
                    invItem.stock -= ingredient.quantity;
                }
            });
            
            let totalIngredientQuality = itemToSell.ingredients.reduce((sum, ing) => {
                const invItem = gameState.shop.inventory.find(inv => inv.name === ing.name);
                return sum + (invItem ? invItem.quality : 0);
            }, 0);
            let avgIngredientQuality = totalIngredientQuality / itemToSell.ingredients.length;
            
            // --- Use staff barista skill for quality adjustment ---
            const servingEmployee = gameState.employees[Math.floor(Math.random() * gameState.employees.length)];
            const effectiveBaristaSkill = servingEmployee.skills.barista * servingEmployee.morale;
            const finalQuality = avgIngredientQuality * (1 + (effectiveBaristaSkill - 0.5)); // +/- quality
            
            const satisfactionChange = (finalQuality * 2) - 1; // Between -1 and 1
            gameState.shop.customerSatisfaction = Math.max(0, Math.min(1, gameState.shop.customerSatisfaction + (satisfactionChange * 0.05)));

            // Reputation is also affected by quality
            gameState.shop.reputation = Math.max(0, Math.min(1, gameState.shop.reputation + (satisfactionChange * 0.02)));

            let income = itemToSell.price;
            let profit = income - cogsForThisItem;

            gameState.player.money += income;
            gameState.player.finances.salesRevenue += income;
            gameState.player.finances.cogs += cogsForThisItem;
            
            animateCoin(Math.random() * canvas.width, canvas.height, 'üí∞', income);
        }

        function checkRandomEvent() {
            // If an event is active, decrease its duration
            if (gameState.currentEvent && gameState.eventDuration > 0) {
                gameState.eventDuration--;
                // --- Fix: Check if event is still active before logging its name
                if (gameState.eventDuration === 0) {
                    if (gameState.currentEvent) {
                        gameState.player.eventLog.push(`‚úÖ ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: "${gameState.currentEvent.name}" ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß!`);
                    }
                    gameState.currentEvent = null; // Event ends
                }
            }

            // If no event is active, check for a new one
            if (!gameState.currentEvent) {
                const rand = Math.random();
                let cumulativeProbability = 0;
                for (const event of gameEvents) {
                    cumulativeProbability += event.probability;
                    if (rand < cumulativeProbability) {
                        gameState.currentEvent = event;
                        gameState.eventDuration = event.duration;
                        gameState.player.eventLog.push(`üîî ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà: "${event.name}" - ${event.description}`);
                        break;
                    }
                }
            }
        }

        function goNextDay() {
            checkRandomEvent();
            currentSupplierPrices = getSupplierPrices();

            gameState.player.day++;
            gameState.player.daysInMonth++;
            if (gameState.player.daysInMonth > 30) {
                gameState.player.daysInMonth = 1;
            }

            // Check for R&D completion
            if (gameState.research && gameState.research.activeProject) {
                gameState.research.daysRemaining--;
                if (gameState.research.daysRemaining <= 0) {
                    const project = gameState.research.activeProject;
                    if (project.effect.type === "unlock_menu") {
                        gameState.shop.menu.push(project.effect.menuItem);
                        gameState.player.eventLog.push(`‚ú® ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ${project.name} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß!`);
                    } else if (project.effect.type === "staff_skill_up") {
                        // This effect is now obsolete with the new training system. Keeping it for backward compatibility
                        gameState.player.eventLog.push(`‚ú® ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ${project.name} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏±‡∏Å‡∏©‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô!`);
                        const researchProject = gameState.research.projects.find(p => p.name === project.name);
                        if (researchProject) {
                            researchProject.unlocked = true;
                        }
                    } else if (project.effect.type === "unlock_training") {
                        // The unlock training is now tied to a flag on the project itself
                        const researchProject = gameState.research.projects.find(p => p.name === project.name);
                        if (researchProject) {
                             researchProject.unlocked = true;
                        }
                        gameState.player.eventLog.push(`‚ú® ‡∏ß‡∏¥‡∏à‡∏±‡∏¢ ${project.name} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ${getThaiSkill(project.effect.skillToTrain)} ‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß.`);
                    }
                    gameState.research.activeProject = null;
                }
            }

            // --- New: Check for staff training completion ---
            if (gameState.training.activeTraining) {
                gameState.training.daysRemaining--;
                if (gameState.training.daysRemaining <= 0) {
                    const { staffName, skillToTrain } = gameState.training.activeTraining;
                    const staff = gameState.employees.find(emp => emp.name === staffName);
                    if (staff) {
                        staff.skills[skillToTrain] = Math.min(1, staff.skills[skillToTrain] + 0.15); // Increase skill
                        gameState.player.eventLog.push(`üéâ ${staffName} ‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ${getThaiSkill(skillToTrain)} ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß!`);
                    }
                    gameState.training.activeTraining = null;
                }
            }

            gameState.player.finances.salesRevenue = 0;
            gameState.player.finances.cogs = 0;
            gameState.player.finances.operatingExpenses = 0;

            // --- New: Morale changes based on days worked ---
            gameState.employees.forEach(emp => {
                const moraleChange = (Math.random() - 0.5) * 0.05;
                emp.morale = Math.max(0.5, Math.min(1, emp.morale + moraleChange));
            });
            
            // Generate customers for the day based on customer types
            let dailyCustomerBase = Math.floor(gameState.shop.reputation * 100) + Math.floor(Math.random() * 20);
            let customerDistribution = {};
            for (let i = 0; i < dailyCustomerBase; i++) {
                const customer = getCustomerType();
                if (customerDistribution[customer.name]) {
                    customerDistribution[customer.name]++;
                } else {
                    customerDistribution[customer.name] = 1;
                }
            }
            
            let totalSalesCount = 0;
            for (const customerType in customerDistribution) {
                const customer = customerTypes.find(c => c.name === customerType);
                let salesMultiplier = 1;
                if (gameState.currentEvent && gameState.currentEvent.effect.customerMultiplier) {
                    salesMultiplier *= gameState.currentEvent.effect.customerMultiplier;
                }
                
                const customersForType = customerDistribution[customerType];
                for (let i = 0; i < customersForType * salesMultiplier; i++) {
                    const availableForSale = gameState.shop.menu.filter(item => {
                        const hasRequiredEquipment = item.equipment.every(eqType => 
                            gameState.shop.equipment.some(playerEq => playerEq.name.includes(eqType))
                        );
                        const hasIngredients = item.ingredients.every(requiredIngredient => {
                            const availableIngredient = gameState.shop.inventory.find(inv => inv.name === requiredIngredient.name);
                            return availableIngredient && availableIngredient.stock >= requiredIngredient.quantity;
                        });
                        return hasRequiredEquipment && hasIngredients;
                    });
                    
                    if (availableForSale.length > 0) {
                        let itemToSell = availableForSale[Math.floor(Math.random() * availableForSale.length)];
                        // Apply customer preference logic
                        let preferredItems = availableForSale.filter(item => customer.preference.some(pref => item.name.includes(pref) || (item.tags && item.tags.includes(pref))));
                        if (preferredItems.length > 0) {
                            itemToSell = preferredItems[Math.floor(Math.random() * preferredItems.length)];
                        }
                        // Apply event-based preferences
                        if (gameState.currentEvent) {
                            if (gameState.currentEvent.effect.coldDrinkMultiplier && itemToSell.name.includes('‡πÄ‡∏¢‡πá‡∏ô')) {
                                itemToSell = availableForSale.find(item => item.name.includes('‡πÄ‡∏¢‡πá‡∏ô')) || itemToSell;
                            }
                            if (gameState.currentEvent.effect.hotDrinkMultiplier && itemToSell.name.includes('‡∏£‡πâ‡∏≠‡∏ô')) {
                                 itemToSell = availableForSale.find(item => item.name.includes('‡∏£‡πâ‡∏≠‡∏ô')) || itemToSell;
                            }
                        }
                        
                        sellMenuItem(itemToSell.name);
                        totalSalesCount++;
                    }
                }
            }
            
            let dailyExpenses = gameState.player.dailyRent;
            gameState.player.loan.dailyInterest = Math.round(gameState.player.loan.amount * gameState.player.loan.interestRate / 30);
            dailyExpenses += gameState.player.loan.dailyInterest;

            // --- New: Marketing effectiveness depends on marketing skill of staff ---
            const totalMarketingSkill = gameState.employees.reduce((sum, emp) => sum + (emp.skills.marketing || 0) * emp.morale, 0);
            gameState.shop.customerSatisfaction += gameState.shop.marketingBudget * 0.0001 * (1 + totalMarketingSkill);
            gameState.shop.reputation += gameState.shop.marketingBudget * 0.0001 * (1 + totalMarketingSkill);
            
            if (gameState.shop.customerSatisfaction > 1) gameState.shop.customerSatisfaction = 1;
            if (gameState.shop.reputation > 1) gameState.shop.reputation = 1;
            
            gameState.player.money -= gameState.shop.marketingBudget;
            dailyExpenses += gameState.shop.marketingBudget;
            gameState.shop.marketingBudget = 0;

            if (gameState.player.daysInMonth === 1) {
                const totalWages = gameState.employees.reduce((acc, emp) => acc + emp.wage, 0);
                dailyExpenses += totalWages;
                gameState.player.eventLog.push(`üí∞ ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${totalWages.toLocaleString()} ‡∏ö‡∏≤‡∏ó.`);
            }

            gameState.player.finances.operatingExpenses = dailyExpenses;
            gameState.player.money -= dailyExpenses;
            
            gameState.player.finances.grossProfit = gameState.player.finances.salesRevenue - gameState.player.finances.cogs;
            gameState.player.finances.netProfit = gameState.player.finances.grossProfit - gameState.player.finances.operatingExpenses;

            gameState.player.finances.inventoryValue = gameState.shop.inventory.reduce((sum, item) => sum + (item.stock * item.cost), 0);
            gameState.player.finances.totalAssets = gameState.player.money + gameState.player.finances.inventoryValue;

            gameState.player.eventLog.push(`‚òÄÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${gameState.player.day} ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏•‡∏á. ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ${totalSalesCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£. ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${gameState.player.finances.netProfit.toLocaleString()} ‡∏ö‡∏≤‡∏ó.`);

            if (gameState.player.money <= 0) {
                showMessage("‡∏Ñ‡∏∏‡∏ì‡∏•‡πâ‡∏°‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡πÄ‡∏Å‡∏°‡πÇ‡∏≠‡πÄ‡∏ß‡∏≠‡∏£‡πå.");
                resetGame();
                return;
            }

            updateUI();
            drawCanvas();
        }
        
        function resetGame() {
            gameState = JSON.parse(JSON.stringify(initialGameState));
            updateUI();
        }

        // --- Panel Functions ---
        function renderPricePanel() {
            menuItemSelect.innerHTML = '';
            gameState.shop.menu.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${item.price.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                menuItemSelect.appendChild(option);
            });
            const selectedItem = gameState.shop.menu.find(item => item.name === menuItemSelect.value);
            if (selectedItem) {
                newPriceInput.value = selectedItem.price;
            }
        }
        function renderBuyPanel() {
            buyItemTableBody.innerHTML = '';
            let totalCost = 0;
            
            buyableProducts.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                const currentStock = gameState.shop.inventory.find(item => item.name === product.name)?.stock || 0;
                const cost = currentSupplierPrices[product.name].price;
                const quality = currentSupplierPrices[product.name].quality;
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${product.name} (‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û ${(quality*100).toFixed(0)}%)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${currentStock} ‡∏´‡∏ô‡πà‡∏ß‡∏¢</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="number" data-name="${product.name}" data-cost="${cost}" data-quality="${quality}" min="0" value="0" class="w-20 p-1 bg-gray-600 rounded-md text-center text-gray-100 quantity-input">
                    </td>
                `;
                buyItemTableBody.appendChild(row);
            });
            buyItemTableBody.addEventListener('input', (e) => {
                if (e.target.classList.contains('quantity-input')) {
                    totalCost = 0;
                    buyItemTableBody.querySelectorAll('.quantity-input').forEach(input => {
                        totalCost += parseInt(input.dataset.cost) * parseInt(input.value);
                    });
                    payBtn.textContent = `‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô (${totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó)`;
                }
            });
            payBtn.addEventListener('click', () => {
                if (gameState.player.money < totalCost) {
                    showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠!");
                    return;
                }
                buyItemTableBody.querySelectorAll('.quantity-input').forEach(input => {
                    const quantity = parseInt(input.value);
                    if (quantity > 0) {
                        buyItem(input.dataset.name, parseInt(input.dataset.cost), quantity, parseFloat(input.dataset.quality));
                    }
                });
                gameState.player.eventLog.push(`üõí ‡∏ã‡∏∑‡πâ‡∏≠‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${totalCost.toLocaleString()} ‡∏ö‡∏≤‡∏ó`);
                hidePanel(buyPanel);
                updateUI();
            });
        }
        function renderEquipmentPanel() {
            equipmentItemTableBody.innerHTML = '';
            availableEquipment.forEach(eq => {
                const hasEquipment = gameState.shop.equipment.some(playerEq => playerEq.name === eq.name);
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${eq.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${eq.cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${hasEquipment ? 'text-green-400' : 'text-red-400'}">${hasEquipment ? '‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="buy-eq-btn px-4 py-2 rounded-lg font-bold text-white transition-colors duration-200 ${hasEquipment || gameState.player.money < eq.cost ? 'bg-gray-500 cursor-not-allowed' : 'bg-gradient-to-br from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700'}" data-name="${eq.name}" ${hasEquipment || gameState.player.money < eq.cost ? 'disabled' : ''}>
                            ‡∏ã‡∏∑‡πâ‡∏≠
                        </button>
                    </td>
                `;
                equipmentItemTableBody.appendChild(row);
            });
            equipmentItemTableBody.querySelectorAll('.buy-eq-btn').forEach(btn => {
                btn.addEventListener('click', () => buyEquipment(btn.dataset.name));
            });
        }
        // --- Modified: Render Staff Panel to show new skills and training ---
        function renderStaffPanel() {
            staffTableBody.innerHTML = '';
            document.getElementById('staff-count').textContent = gameState.employees.length;
            gameState.employees.forEach(staff => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700';
                
                const skillsHtml = Object.entries(staff.skills).map(([key, value]) => `
                    <p class="text-xs text-gray-400">${getThaiSkill(key)}: ${(value*100).toFixed(0)}%</p>
                `).join('');

                const isTraining = gameState.training.activeTraining?.staffName === staff.name;
                const trainingBtnClass = isTraining ? 'bg-gray-500 cursor-not-allowed' : 'bg-gradient-to-br from-indigo-500 to-blue-600';
                const trainingBtnText = isTraining ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏° (${gameState.training.daysRemaining} ‡∏ß‡∏±‡∏ô)` : '‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°';
                
                // Get available skills from research projects that are unlocked
                const unlockedTrainingSkills = gameState.research.projects
                    .filter(p => p.unlocked && p.effect?.type === "unlock_training")
                    .map(p => p.effect.skillToTrain);

                const trainingDropdown = `
                    <select class="p-1 text-xs bg-gray-600 rounded-md text-gray-100">
                        ${unlockedTrainingSkills.map(skill => `<option value="${skill}">${getThaiSkill(skill)}</option>`).join('')}
                    </select>
                `;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-100">${staff.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${staff.wage.toLocaleString()} ‡∏ö‡∏≤‡∏ó</td>
                    <td class="px-6 py-4 text-sm text-gray-300">
                        ${skillsHtml}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${(staff.morale * 100).toFixed(0)}%</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium flex flex-col gap-2">
                        <div class="flex gap-2 items-center">
                            ${trainingDropdown}
                            <button class="train-staff-btn px-2 py-1 rounded-lg font-bold text-white text-xs transition-colors duration-200 ${trainingBtnClass}" data-name="${staff.name}" ${isTraining || unlockedTrainingSkills.length === 0 ? 'disabled' : ''}>
                                ${trainingBtnText}
                            </button>
                        </div>
                        <div class="flex gap-2">
                            <button class="bonus-staff-btn flex-1 px-2 py-1 rounded-lg font-bold text-white text-xs transition-colors duration-200 bg-gradient-to-br from-green-500 to-emerald-600" data-name="${staff.name}">
                                ‡πÇ‡∏ö‡∏ô‡∏±‡∏™
                            </button>
                            <button class="fire-staff-btn flex-1 px-2 py-1 rounded-lg font-bold text-white text-xs transition-colors duration-200 bg-gradient-to-br from-red-500 to-rose-600" data-name="${staff.name}">
                                ‡πÑ‡∏•‡πà‡∏≠‡∏≠‡∏Å
                            </button>
                        </div>
                    </td>
                `;
                staffTableBody.appendChild(row);
            });
            staffTableBody.querySelectorAll('.fire-staff-btn').forEach(btn => {
                btn.addEventListener('click', () => fireStaff(btn.dataset.name));
            });
            // --- MODIFIED: Added confirmation for training and bonus ---
            staffTableBody.querySelectorAll('.train-staff-btn').forEach(btn => {
                const staffName = btn.dataset.name;
                const skillDropdown = btn.parentElement.querySelector('select');
                if (btn.disabled) return;
                btn.addEventListener('click', () => {
                    const skillToTrain = skillDropdown.value;
                    const confirmationMessage = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°‡∏ó‡∏±‡∏Å‡∏©‡∏∞ ${getThaiSkill(skillToTrain)} ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö ${staffName} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
                    showConfirmation(confirmationMessage, () => {
                        trainStaff(staffName, skillToTrain);
                    });
                });
            });
            staffTableBody.querySelectorAll('.bonus-staff-btn').forEach(btn => {
                const staffName = btn.dataset.name;
                btn.addEventListener('click', () => {
                    const confirmationMessage = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™ ${staffName} ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏ß‡∏±‡∏ç‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`;
                    showConfirmation(confirmationMessage, () => {
                        giveBonus(staffName);
                    });
                });
            });
        }
        function getThaiSkill(skill) {
            switch(skill) {
                case 'barista': return '‡∏ö‡∏≤‡∏£‡∏¥‡∏™‡∏ï‡πâ‡∏≤';
                case 'speed': return '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß';
                case 'service': return '‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£';
                case 'marketing': return '‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î';
                default: return skill;
            }
        }
        function renderMarketingPanel() {
            currentMarketingBudget.textContent = gameState.shop.marketingBudget.toLocaleString();
            marketingSlider.value = gameState.shop.marketingBudget;
            marketingBudgetDisplay.textContent = gameState.shop.marketingBudget.toLocaleString();
            marketingSlider.max = gameState.player.money;
            if (marketingSlider.max < marketingSlider.value) {
                 marketingSlider.value = marketingSlider.max;
                 marketingBudgetDisplay.textContent = marketingSlider.value.toLocaleString();
            }
        }
        function renderLoanPanel() {
            currentLoanAmount.textContent = gameState.player.loan.amount.toLocaleString();
            dailyLoanInterest.textContent = (gameState.player.loan.amount * gameState.player.loan.interestRate / 30).toFixed(2);
            loanAmountInput.value = '';
        }

        function renderReportsPanel() {
            document.getElementById('sales-revenue').textContent = `${gameState.player.finances.salesRevenue.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('cogs').textContent = `${gameState.player.finances.cogs.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('gross-profit').textContent = `${gameState.player.finances.grossProfit.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('operating-expenses').textContent = `${gameState.player.finances.operatingExpenses.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('net-profit').textContent = `${gameState.player.finances.netProfit.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            
            document.getElementById('assets-cash').textContent = `${gameState.player.money.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('assets-supplies').textContent = `${gameState.player.finances.inventoryValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('total-assets').textContent = `${gameState.player.money + gameState.player.finances.inventoryValue.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
            document.getElementById('liabilities-loan').textContent = `${gameState.player.loan.amount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
        }

        function renderResearchPanel() {
            researchProjectList.innerHTML = '';
            // --- Fix: Add defensive check for research and projects array
            if (!gameState.research || !gameState.research.projects) {
                const p = document.createElement('p');
                p.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°‡πÉ‡∏´‡∏°‡πà";
                p.className = "text-center text-red-400";
                researchProjectList.appendChild(p);
                return;
            }
            
            gameState.research.projects.forEach(project => {
                const hasUnlocked = project.effect.type === "unlock_menu" ? gameState.shop.menu.some(menuItem => menuItem.name === project.effect.menuItem?.name) : project.unlocked;
                const isActive = gameState.research.activeProject?.name === project.name;
                const projectDiv = document.createElement('div');
                projectDiv.className = `bg-gray-800 p-4 rounded-lg shadow-md mb-2 flex items-center justify-between transition-colors duration-200 ${isActive ? 'bg-indigo-900' : ''}`;
                
                let buttonHtml = '';
                if (hasUnlocked) {
                    buttonHtml = `<span class="text-green-400 font-bold">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>`;
                } else if (isActive) {
                    buttonHtml = `<span class="text-yellow-400 font-bold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏à‡∏±‡∏¢ (${gameState.research.daysRemaining} ‡∏ß‡∏±‡∏ô)</span>`;
                } else {
                    buttonHtml = `<button class="start-research-btn btn bg-gradient-to-br from-indigo-500 to-blue-600 py-2 px-4 text-base" data-name="${project.name}" data-cost="${project.cost}">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡∏à‡∏±‡∏¢</button>`;
                }
                
                projectDiv.innerHTML = `
                    <div>
                        <h4 class="text-lg font-bold text-teal-400">${project.name}</h4>
                        <p class="text-sm text-gray-300">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢: ${project.cost.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
                        <p class="text-sm text-gray-300">‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤: ${project.daysToComplete} ‡∏ß‡∏±‡∏ô</p>
                    </div>
                    <div>
                        ${buttonHtml}
                    </div>
                `;
                researchProjectList.appendChild(projectDiv);
            });

            researchProjectList.querySelectorAll('.start-research-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const projectName = btn.dataset.name;
                    const cost = parseInt(btn.dataset.cost);
                    const project = gameState.research.projects.find(p => p.name === projectName);
                    
                    if (gameState.research.activeProject) {
                        showMessage("‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡∏≠‡∏∑‡πà‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡∏π‡πà");
                        return;
                    }
                    if (gameState.player.money < cost) {
                        showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ß‡∏¥‡∏à‡∏±‡∏¢!");
                        return;
                    }

                    gameState.player.money -= cost;
                    gameState.research.activeProject = project;
                    gameState.research.daysRemaining = project.daysToComplete;
                    gameState.player.eventLog.push(`üß™ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢: "${project.name}"`);
                    
                    renderResearchPanel();
                    updateUI();
                });
            });
        }


        // --- Canvas Drawing Functions ---
        let particles = [];
        function drawCanvas() {
            // Clear canvas
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = '#4A5568';
            ctx.fillRect(50, canvas.height - 200, canvas.width - 100, 150);
            ctx.fillStyle = '#E2E8F0';
            ctx.fillRect(80, canvas.height - 180, 50, 50);
            ctx.fillRect(canvas.width - 130, canvas.height - 180, 50, 50);
            
            ctx.fillStyle = '#CBD5E0';
            ctx.font = '24px Poppins';
            ctx.textAlign = 'center';
            ctx.fillText('‚òïÔ∏è Coffee Shop ‚òïÔ∏è', canvas.width / 2, canvas.height / 2);
            ctx.fillText(`‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${(gameState.shop.reputation * 100).toFixed(0)}%`, canvas.width / 2, canvas.height / 2 + 40);
            if (gameState.currentEvent) {
                ctx.fillStyle = '#FBBF24';
                ctx.font = '20px Poppins';
                ctx.fillText(`üì¢ ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå: ${gameState.currentEvent.name}`, canvas.width / 2, canvas.height / 2 + 80);
            }
            if (gameState.research && gameState.research.activeProject) {
                ctx.fillStyle = '#6EE7B7';
                ctx.font = '16px Poppins';
                ctx.fillText(`üß™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡∏à‡∏±‡∏¢: ${gameState.research.activeProject.name} (${gameState.research.daysRemaining} ‡∏ß‡∏±‡∏ô)`, canvas.width / 2, canvas.height / 2 + 120);
            }
            if (gameState.training.activeTraining) {
                ctx.fillStyle = '#6EE7B7';
                ctx.font = '16px Poppins';
                ctx.fillText(`üìö ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ù‡∏∂‡∏Å‡∏≠‡∏ö‡∏£‡∏°: ${gameState.training.activeTraining.staffName} (${gameState.training.daysRemaining} ‡∏ß‡∏±‡∏ô)`, canvas.width / 2, canvas.height / 2 + 160);
            }

            // Draw particles (coins)
            particles.forEach((p, index) => {
                ctx.save();
                ctx.font = '32px Poppins';
                ctx.textAlign = 'center';
                ctx.fillStyle = 'gold';
                ctx.fillText(p.text, p.x, p.y);
                ctx.restore();
                p.y -= p.speed;
                p.opacity -= 0.01;
                if (p.opacity < 0) {
                    particles.splice(index, 1);
                }
            });
        }
        function animateCoin(x, y, text, value) {
            particles.push({
                x: x,
                y: y,
                text: `${text} +${value.toLocaleString()}`,
                speed: Math.random() * 2 + 1,
                opacity: 1
            });
        }
        
        function gameLoop() {
            drawCanvas();
            requestAnimationFrame(gameLoop);
        }
        gameLoop(); // Start the animation loop

        // --- Event Listeners ---
        document.getElementById('set-price-btn').addEventListener('click', () => {
            renderPricePanel();
            showPanel(pricePanel);
        });
        document.getElementById('buy-raw-btn').addEventListener('click', () => {
            renderBuyPanel();
            showPanel(buyPanel);
        });
        document.getElementById('buy-equipment-btn').addEventListener('click', () => {
            renderEquipmentPanel();
            showPanel(equipmentPanel);
        });
        document.getElementById('hire-staff-btn').addEventListener('click', () => {
            renderStaffPanel();
            showPanel(hireStaffPanel);
        });
        document.getElementById('marketing-btn').addEventListener('click', () => {
            renderMarketingPanel();
            showPanel(marketingPanel);
        });
        document.getElementById('loan-btn').addEventListener('click', () => {
            renderLoanPanel();
            showPanel(loanPanel);
        });
        document.getElementById('reports-btn').addEventListener('click', () => {
            renderReportsPanel();
            showPanel(reportsPanel);
        });
        document.getElementById('research-btn').addEventListener('click', () => {
            renderResearchPanel();
            showPanel(researchPanel);
        });
        document.getElementById('hire-new-staff-btn').addEventListener('click', hireStaff);


        confirmPriceBtn.addEventListener('click', () => {
            const selectedName = menuItemSelect.value;
            const newPrice = parseInt(newPriceInput.value);
            if (!selectedName || isNaN(newPrice) || newPrice < 0) {
                showMessage('‡∏£‡∏≤‡∏Ñ‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            const itemToUpdate = gameState.shop.menu.find(item => item.name === selectedName);
            if (itemToUpdate) {
                itemToUpdate.price = newPrice;
                gameState.player.eventLog.push(`‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≠‡∏á ${selectedName} ‡∏ñ‡∏π‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô ${newPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó.`);
            }
            hidePanel(pricePanel);
            updateUI();
        });
        cancelPriceBtn.addEventListener('click', () => hidePanel(pricePanel));
        cancelBuyBtn.addEventListener('click', () => hidePanel(buyPanel));
        cancelEquipmentBtn.addEventListener('click', () => hidePanel(equipmentPanel));
        cancelStaffBtn.addEventListener('click', () => hidePanel(hireStaffPanel));
        cancelMarketingBtn.addEventListener('click', () => hidePanel(marketingPanel));
        cancelLoanBtn.addEventListener('click', () => hidePanel(loanPanel));
        cancelReportsBtn.addEventListener('click', () => hidePanel(reports-panel));
        cancelResearchBtn.addEventListener('click', () => hidePanel(researchPanel));


        marketingSlider.addEventListener('input', () => {
            marketingBudgetDisplay.textContent = marketingSlider.value.toLocaleString();
        });
        confirmMarketingBtn.addEventListener('click', () => {
            const budget = parseInt(marketingSlider.value);
            if (gameState.player.money < budget) {
                showMessage("‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏∏‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î!");
                return;
            }
            gameState.shop.marketingBudget = budget;
            gameState.player.eventLog.push(`‡πÉ‡∏ä‡πâ‡πÄ‡∏á‡∏¥‡∏ô ${budget.toLocaleString()} ‡∏ö‡∏≤‡∏ó‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏•‡∏≤‡∏î‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ.`);
            hidePanel(marketingPanel);
            updateUI();
        });

        requestLoanBtn.addEventListener('click', () => {
            const loanAmount = parseInt(loanAmountInput.value);
            if (isNaN(loanAmount) || loanAmount <= 0) {
                showMessage("‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                return;
            }
            gameState.player.money += loanAmount;
            gameState.player.loan.amount += loanAmount;
            gameState.player.eventLog.push(`‡∏Å‡∏π‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö ${loanAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó.`);
            hidePanel(loanPanel);
            updateUI();
        });

        document.getElementById('next-day-btn').addEventListener('click', goNextDay);
        document.getElementById('save-game-btn').addEventListener('click', saveGame);
        document.getElementById('load-game-btn').addEventListener('click', loadGame);

        // Initial setup
        window.onload = () => {
            loadGame();
            drawCanvas();
        };

    </script>
</body>
</html>
