<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ข้อมูลสเปกโน้ตบุ๊ก</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            font-size: 1.125rem; /* เพิ่มขนาดตัวอักษรพื้นฐาน */
        }
        /* Custom styles for the dropdowns to match the design */
        select, button {
            transition: all 0.2s ease-in-out;
        }

        /* CSS สำหรับการไฮไลท์และทำให้ส่วนอื่นมืดลง */
        .rating-bar-container {
            transition: opacity 0.15s ease-in-out;
            border-radius: 0.25rem; /* rounded-sm */
        }

        /* New class for the main spec sections to apply highlight/dimming */
        .spec-section-container {
            transition: opacity 0.15s ease-in-out, transform 0.15s ease-in-out, box-shadow 0.15s ease-in-out, border 0.15s ease-in-out;
            border-radius: 0.5rem; /* rounded-lg, adjust as needed */
            border: 4px solid transparent; /* Default transparent border for the section */
            padding: 0.5rem; /* Add some padding so the border doesn't clip content */
            margin: -0.5rem; /* Counteract padding to maintain layout */
            cursor: pointer; /* แสดงว่าสามารถคลิกได้ที่กรอบ */
        }

        /* When global dimming is active, dim non-highlighted spec sections */
        body.global-dim-active .spec-section-container:not(.highlight-active) {
            opacity: 0.2;
            transform: scale(0.98); /* Slightly scale down the dimmed sections */
        }

        /* Highlighted spec section */
        body.global-dim-active .spec-section-container.highlight-active {
            opacity: 1;
            transform: scale(1.0); /* No scaling for highlighted section */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            border: 4px solid white; /* Thick white border for the entire section */
        }
        
        /* New class for dimming an entire section and its children */
        .is-common {
            opacity: 0.4;
        }


        /* Adjusted padding for the main laptop card to reduce height */
        .laptop-card-main {
            padding: 1rem; /* Reduced from p-6 (24px) to p-4 (16px) or p-3 (12px) for 10% reduction */
            transition: opacity 0.3s ease-in-out, blur 0.3s ease-in-out;
        }

        .link-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-decoration: none;
            color: inherit;
        }
        
        .price-toggle {
            cursor: pointer;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body class="min-h-screen p-4 md:p-8 pb-[15vh]">

    <div id="app-container" class="max-w-7xl mx-auto w-full">
        <h1 class="text-4xl font-extrabold text-gray-800 text-center mb-6 tracking-tight">
            ข้อมูลสเปกโน้ตบุ๊ก
        </h1>

        <!-- Dropdowns and Model Selection -->
        <div class="flex flex-wrap justify-center gap-4 mb-8">
            <select id="brand-select" class="p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-700 font-bold shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                <option value="">-- เลือกแบรนด์ --</option>
            </select>
            <select id="series-select" class="p-3 rounded-lg border-2 border-gray-300 bg-white text-gray-700 font-bold shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50" disabled>
                <option value="">-- เลือกซีรีส์ --</option>
            </select>
        </div>

        <!-- Container for model selection buttons -->
        <div id="model-selection-container" class="flex flex-col items-center mb-8 hidden">
            <p class="text-center text-sm text-gray-600 mb-2">
                แตะเพื่อเลือกรุ่นโน้ตบุ๊กที่คุณต้องการเปรียบเทียบ (สูงสุด 3 รุ่น)
            </p>
            <div id="model-buttons" class="flex flex-wrap justify-center gap-2 max-w-xl">
                <!-- Model buttons will be injected here -->
            </div>
        </div>

        <!-- Sorting controls -->
        <div id="sort-controls" class="flex flex-wrap justify-center gap-2 mb-8">
            <label for="sort-by-select" class="flex items-center text-gray-700 font-bold">เรียงตาม:</label>
            <select id="sort-by-select" class="p-2 rounded-lg border-2 border-gray-300 bg-white text-gray-700 font-bold shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                <option value="price">ราคา</option>
                <option value="cpuSpeed">ความเร็ว CPU</option>
                <option value="cpuMulti">ทำงานหลายอย่างพร้อมกัน</option>
                <option value="gpuRating">การ์ดจอ</option>
            </select>
            <button id="sort-order-btn" class="p-2 rounded-lg border-2 border-gray-300 bg-white text-gray-700 font-bold shadow-sm hover:bg-gray-100 transition-colors duration-200">
                <!-- SVG icon for sort order will be here -->
                <svg id="sort-icon-up" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="display: none;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
                </svg>
                <svg id="sort-icon-down" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <!-- Checkbox for showing differences only, added as requested -->
            <div class="flex items-center space-x-2 ml-4">
                <label for="show-diff-checkbox" class="text-gray-700 font-bold">แสดงเฉพาะจุดที่แตกต่าง</label>
                <input type="checkbox" id="show-diff-checkbox" class="form-checkbox h-5 w-5 text-indigo-600 rounded-md focus:ring-indigo-500 cursor-pointer" />
            </div>
        </div>

        <!-- Container for selected laptops display -->
        <div id="selected-laptops-display-container" class="flex flex-wrap justify-center gap-4 mb-8">
            <!-- Selected laptop models will be displayed here -->
        </div>

        <!-- Container for the laptop cards -->
        <div id="laptop-cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Laptop cards will be injected here -->
        </div>

        <!-- Loading and Error messages -->
        <div id="loading-message" class="flex items-center justify-center p-8">
            <div class="text-xl font-bold text-gray-700">กำลังโหลดข้อมูล...</div>
        </div>
        <div id="error-message" class="hidden min-h-screen flex items-center justify-center p-4">
            <div class="bg-white p-8 rounded-lg shadow-xl max-w-lg text-center">
                <h2 class="text-2xl font-bold text-red-600 mb-4">ข้อผิดพลาดในการโหลดข้อมูล</h2>
                <p class="text-gray-700 mb-4">
                    โปรดตรวจสอบ Google Sheet ของคุณเพื่อให้แน่ใจว่าได้เผยแพร่เป็นไฟล์ CSV และรูปแบบข้อมูลถูกต้อง
                </p>
                <p id="error-details" class="text-sm text-gray-500 italic"></p>
            </div>
        </div>
    </div>

    <script>
        // =================================================================
        // ส่วนที่ 1: การตั้งค่าและตัวแปรหลัก
        // =================================================================
        // URL for fetching data from the Google Sheet in CSV format.
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTTMANBtr1zMXdrfz75Pfa7YkWOF97IhfgWFRz9KE4WoZOX0dQXVt6t7VPfjxjFbkH3SSb451ZfmuYR/pub?gid=754160478&single=true&output=csv";

        // Variables for application state.
        let allLaptops = [];
        let dropdownData = {};
        let selectedModels = [];
        const workload = 'normal';
        let sortCriteria = 'price';
        let sortOrder = 'asc';
        let currentHighlightedSpecType = null; // Global state for clicked spec type
        let showDifferencesOnly = false; // New state variable for the checkbox
        let isDisplayDetailsShown = false; // New state variable for the display toggle

        // Store logo information
        const storeLogos = {
            jib: 'https://www.jib.co.th/web/images/logo/logo-b.png',
            advice: 'https://notebookspec.com/web/wp-content/uploads/2020/02/logo-color.png',
            bananait: 'https://images.seeklogo.com/logo-png/16/1/banana-it-logo-png_seeklogo-168840.png',
            // Our Store was here
        };

        // References to various elements on the page.
        const appContainer = document.getElementById('app-container');
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const errorDetails = document.getElementById('error-details');
        const brandSelect = document.getElementById('brand-select');
        const seriesSelect = document.getElementById('series-select');
        const modelSelectionContainer = document.getElementById('model-selection-container');
        const modelButtonsContainer = document.getElementById('model-buttons');
        const selectedLaptopsDisplayContainer = document.getElementById('selected-laptops-display-container');
        const laptopCardsContainer = document.getElementById('laptop-cards-container');
        const sortBySelect = document.getElementById('sort-by-select');
        const sortOrderBtn = document.getElementById('sort-order-btn');
        const sortIconUp = document.getElementById('sort-icon-up');
        const sortIconDown = document.getElementById('sort-icon-down');
        // New reference to the difference checkbox
        const showDiffCheckbox = document.getElementById('show-diff-checkbox');
        // Removed globalToggleDisplayDetailsBtn as it's no longer global

        // =================================================================
        // ส่วนที่ 2: ฟังก์ชันสำหรับประมวลผลข้อมูล
        // =================================================================

        /**
         * Parses a string value, cleans it, and returns a floating-point number.
         * Returns 0 if the value is not a valid number.
         * @param {string} value - The raw string value from the CSV.
         * @returns {number} - The parsed and sanitized number.
         */
        const parseAndSanitizePrice = (value) => {
            // Handle null, undefined, or empty string values
            if (value === null || value === undefined || value.trim() === '') {
                return 0;
            }
            // Remove non-numeric characters except for the decimal point
            const cleanedValue = value.replace(/[^0-9.]/g, '');
            const price = parseFloat(cleanedValue);
            return isNaN(price) ? 0 : price;
        };
        
        /**
         * Parses CSV text into an array of laptop objects.
         * @param {string} csvText - The raw CSV text from Google Sheets.
         * @returns {Array} - An array of laptop objects.
         */
        const parseCSV = (csvText) => {
            const lines = csvText.trim().split('\n');
            if (lines.length <= 1) {
                console.error('CSV data is empty or has no header.');
                return [];
            }
            const headers = lines[0].split(',').map(header => header.trim());
            const data = lines.slice(1);

            const headerMap = new Map();
            headers.forEach((header, index) => headerMap.set(header, index));

            const laptops = data.map(rowText => {
                const row = rowText.split(',').map(cell => cell.trim());
                if (row.length !== headers.length) {
                    console.warn('Skipping malformed row:', rowText);
                    return null;
                }
                
                // Helper function is now defined inside the map loop to access 'row'
                const getCellValue = (header) => {
                    const index = headerMap.get(header);
                    if (index === undefined || row[index] === undefined) return '';
                    return String(row[index]).trim();
                };

                const laptop = {
                    brand_id: getCellValue('brand_id') || 'Unknown',
                    series_id: getCellValue('series_id') || 'Unknown',
                    model_id: getCellValue('Laptop_id') || 'Unknown',
                    prices: {
                        // Use the new helper function to parse all prices
                        base: parseAndSanitizePrice(getCellValue('base_price')),
                        pro: parseAndSanitizePrice(getCellValue('pro_price')),
                        cash: parseAndSanitizePrice(getCellValue('cash_price')),
                    },
                    isDisabled: getCellValue('is_disabled').toUpperCase() === 'TRUE',
                    disabledReason: getCellValue('disabled_reason') || 'สินค้าไม่พร้อมจำหน่าย',
                    cpu: {
                        id: getCellValue('cpu_id') || 'N/A',
                        architecture: getCellValue('cpu_architecture') || 'N/A',
                        releaseYear: getCellValue('release_year') || 'N/A',
                        ratings: {
                            singleNormal: parseFloat(getCellValue('cpu_rating_single_normal')) || 0,
                            singleHeavy: parseFloat(getCellValue('cpu_rating_single_heavy')) || 0,
                            multiNormal: parseFloat(getCellValue('cpu_rating_multi_normal')) || 0,
                            multiHeavy: parseFloat(getCellValue('cpu_rating_multi_heavy')) || 0,
                        },
                    },
                    gpu: {
                        id: getCellValue('gpu') || 'N/A',
                        ratings: {
                            normal: parseFloat(getCellValue('gpu_rating_normal')) || 0,
                            heavy: parseFloat(getCellValue('gpu_rating_heavy')) || 0,
                        },
                        dedicatedGpuId: getCellValue('gpu_2') || 'N/A',
                        dedicatedGpuRating: parseFloat(getCellValue('gpu_2_rating')) || 0,
                    },
                    ram: {
                        value: getCellValue('RAM') || 'N/A',
                        rating: parseFloat(getCellValue('ram_rating')) || 0,
                    },
                    ssd: {
                        value: getCellValue('SSD') || 'N/A',
                        rating: parseFloat(getCellValue('ssd_rating')) || 0,
                    },
                    display: {
                        id: getCellValue('display_id') || 'N/A',
                        rating: parseFloat(getCellValue('display_rating')) || 0,
                        type: getCellValue('display_type') || 'N/A',
                        typeRating: parseFloat(getCellValue('display_type_rating')) || 0,
                        hz: getCellValue('display_hz') || 'N/A',
                        hzRating: parseFloat(getCellValue('display_hz_rating')) || 0,
                        resolution: getCellValue('display_resoulution') || 'N/A',
                        resolutionRating: parseFloat(getCellValue('display_resoulution_rating')) || 0,
                        bright: getCellValue('display_bright') || 'N/A',
                        brightRating: parseFloat(getCellValue('display_bright_rating')) || 0,
                        color: getCellValue('display_colour') || 'N/A',
                        colorRating: parseFloat(getCellValue('display_colour_rating')) || 0,
                        gamingRating: parseFloat(getCellValue('display_rating2')) || 0, // New gaming rating
                    },
                    // Add new fields for store-specific prices and use the new helper function
                    storePrices: {
                        // Corrected field name from 'pro_price_JIB' to 'pro_price_jib'
                        jib: parseAndSanitizePrice(getCellValue('pro_price_jib')),
                        advice: parseAndSanitizePrice(getCellValue('pro_price_advice')),
                        bananait: parseAndSanitizePrice(getCellValue('pro_price_bananait')),
                    },
                    // เพิ่ม links สำหรับร้านค้า
                    storeLinks: {
                        // Corrected field name from 'pro_price_JIB_link' to 'pro_price_jib_link'
                        jib: getCellValue('pro_price_jib_link'),
                        advice: getCellValue('pro_price_advice_link'),
                        bananait: getCellValue('pro_price_bananait_link'),
                    }
                };

                laptop.fullName = `${laptop.brand_id} ${laptop.series_id} ${laptop.model_id}`;
                return laptop;
            }).filter(laptop => laptop !== null && laptop.model_id !== 'Unknown');

            // Filter out specific models as requested by the user.
            return laptops.filter(laptop =>
                laptop.fullName.toLowerCase() !== 'acer aspire lite 15' &&
                laptop.fullName.toLowerCase() !== 'acer aspire lite 16'
            );
        };
        
        /**
         * Identifies which properties are common across all selected laptops.
         * @param {Array} laptops - The array of selected laptop objects.
         * @returns {Object} - An object containing Sets of common properties for each category.
         */
        const getCommonProperties = (laptops) => {
            const commonProps = {
                cpu: new Set(['id', 'architecture', 'releaseYear']),
                gpu: new Set(['id', 'dedicatedGpuId']),
                ram: new Set(['value']),
                ssd: new Set(['value']),
                display: new Set(['id', 'type', 'hz', 'resolution', 'bright', 'color'])
            };

            if (laptops.length <= 1) {
                return commonProps;
            }

            for (const category in commonProps) {
                const firstLaptop = laptops[0];
                const propsToRemove = [];
                for (const prop of commonProps[category]) {
                    // Check if any other laptop has a different value for this property
                    if (laptops.some(laptop => laptop[category][prop] !== firstLaptop[category][prop])) {
                        propsToRemove.push(prop);
                    }
                }
                propsToRemove.forEach(prop => commonProps[category].delete(prop));
            }
            return commonProps;
        };


        /**
         * Fetches data from Google Sheets and initializes the app.
         */
        const fetchData = async () => {
            try {
                loadingMessage.classList.remove('hidden');
                appContainer.classList.add('hidden');
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Failed to fetch data. Status: ${response.status}`);
                }
                const csvText = await response.text();
                allLaptops = parseCSV(csvText);

                if (allLaptops.length === 0) {
                    throw new Error('No valid data found in the Google Sheet.');
                }

                // Build data structure for dropdowns.
                dropdownData = allLaptops.reduce((acc, laptop) => {
                    const { brand_id, series_id, fullName } = laptop;
                    if (!acc[brand_id]) acc[brand_id] = {};
                    if (!acc[brand_id][series_id]) acc[brand_id][series_id] = [];
                    if (!acc[brand_id][series_id].includes(fullName)) {
                        acc[brand_id][series_id].push(fullName);
                    }
                    return acc;
                }, {});

                loadingMessage.classList.add('hidden');
                appContainer.classList.remove('hidden');
                renderDropdowns();
                renderLaptopCards();
                renderSelectedLaptopsDisplay(); // Render selected models on initial load
            } catch (e) {
                console.error('Error fetching or processing data:', e);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorDetails.textContent = `ข้อผิดพลาด: "${e.message}"`;
            }
        };

        // =================================================================
        // ส่วนที่ 3: ฟังก์ชันสำหรับเรนเดอร์ UI
        // =================================================================

        /**
         * Creates HTML for a segmented rating bar (5 segments) with colors based on the rating range.
         * @param {number} rating - The rating to display.
         * @param {string} type - The type of rating (e.g., 'cpuSpeed', 'gpuNormal').
         * @returns {string} - The HTML string for the rating bar.
         */
        const createSegmentedRatingBar = (rating, type) => {
            const maxSegments = 5;
            // Cap the rating at the maximum number of segments.
            const cappedRating = Math.min(rating, maxSegments);
            let segmentsHtml = '';

            // Define colors for each segment based on the user's request.
            const segmentColors = ['#22c55e', '#22c55e', '#3b82f6', '#a855f7', '#f472b6']; // Green, Green, Blue, Purple, Fuchsia
            const emptyColor = '#e5e7eb'; // Default grey for empty segments

            for (let i = 0; i < maxSegments; i++) {
                // Determine the threshold for the current segment (e.g., segment 0 is for rating 0-1)
                const segmentThreshold = i + 1;
                const segmentColor = segmentColors[i];

                if (cappedRating > segmentThreshold) {
                    // Full segment
                    segmentsHtml += `<div class="h-3 flex-grow rounded-sm" style="background-color: ${segmentColor};"></div>`;
                } else if (cappedRating > i) {
                    // Partial segment
                    const partialFillPercentage = (cappedRating - i) * 100;
                    segmentsHtml += `<div class="h-3 flex-grow rounded-sm" style="background: linear-gradient(to right, ${segmentColor} ${partialFillPercentage}%, ${emptyColor} ${partialFillPercentage}%); background-size: 100% 100%; background-repeat: no-repeat;"></div>`;
                } else {
                    // Empty segment
                    segmentsHtml += `<div class="h-3 flex-grow rounded-sm bg-gray-200"></div>`;
                }
            }
            // Add data-rating-type and rating-bar-container class for event delegation
            return `<div class="flex w-full space-x-[2px] mb-2 rating-bar-container" data-rating-type="${type}">${segmentsHtml}</div>`;
        };

        /**
         * Creates and displays the brand and series dropdowns.
         */
        const renderDropdowns = () => {
            brandSelect.innerHTML = '<option value="">-- เลือกแบรนด์ --</option>';
            seriesSelect.innerHTML = '<option value="">-- เลือกซีรีส์ --</option>';

            Object.keys(dropdownData).forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });

            if (localStorage.getItem('selectedBrand')) {
                brandSelect.value = localStorage.getItem('selectedBrand');
                seriesSelect.disabled = false;
                renderSeriesDropdown(brandSelect.value);
            }
            if (localStorage.getItem('selectedSeries')) {
                seriesSelect.value = localStorage.getItem('selectedSeries');
                renderModelButtons(brandSelect.value, seriesSelect.value);
            }
        };

        /**
         * Creates and displays the series dropdown based on the selected brand.
         * @param {string} brand - The selected brand.
         */
        const renderSeriesDropdown = (brand) => {
            seriesSelect.innerHTML = '<option value="">-- เลือกซีรีส์ --</option>';
            if (brand && dropdownData[brand]) {
                Object.keys(dropdownData[brand]).forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    seriesSelect.appendChild(option);
                });
                seriesSelect.disabled = false;
            } else {
                seriesSelect.disabled = true;
            }
        };

        /**
         * Creates and displays the model selection buttons.
         * @param {string} brand - The selected brand.
         * @param {string} series - The selected series.
         */
        const renderModelButtons = (brand, series) => {
            modelButtonsContainer.innerHTML = '';
            if (brand && series && dropdownData[brand] && dropdownData[brand][series]) {
                modelSelectionContainer.classList.remove('hidden');
                dropdownData[brand][series].forEach(modelName => {
                    const button = document.createElement('button');
                    const isSelected = selectedModels.includes(modelName);
                    button.textContent = modelName.split(' ').pop();
                    button.dataset.modelName = modelName;
                    button.className = `py-2 px-4 rounded-full font-bold transition-all duration-200 border-2 ${
                        isSelected
                            ? 'bg-blue-600 text-white border-blue-600 shadow-md'
                            : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'
                    }`;
                    button.addEventListener('click', () => handleModelClick(modelName));
                    modelButtonsContainer.appendChild(button);
                });
            } else {
                modelSelectionContainer.classList.add('hidden');
            }
        };

        /**
         * Renders the currently selected laptop models as small cards/buttons.
         */
        const renderSelectedLaptopsDisplay = () => {
            selectedLaptopsDisplayContainer.innerHTML = '';
            selectedModels.forEach(modelName => {
                const laptop = allLaptops.find(l => l.fullName === modelName);
                if (laptop) {
                    const selectedModelDiv = document.createElement('div');
                    // Add a class to the selected model button for easier targeting for click events
                    selectedModelDiv.className = `flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full shadow-sm selected-model-button`;
                    selectedModelDiv.innerHTML = `
                        <span>${laptop.model_id}</span>
                        <button class="ml-2 text-blue-600 hover:text-blue-900 focus:outline-none" data-model-name="${modelName}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                    `;
                    selectedModelDiv.querySelector('button').addEventListener('click', (e) => {
                        const modelToRemove = e.currentTarget.dataset.modelName;
                        handleModelClick(modelToRemove); // Re-use handleModelClick to remove
                    });
                    // Add click listener to the entire div to clear highlight
                    selectedModelDiv.addEventListener('click', () => clearGlobalHighlight());
                    selectedLaptopsDisplayContainer.appendChild(selectedModelDiv);
                }
            });
        };

        /**
         * Creates and displays the selected laptop cards.
         */
        const renderLaptopCards = () => {
            laptopCardsContainer.innerHTML = '';
            let filteredLaptops = allLaptops.filter(laptop => selectedModels.includes(laptop.fullName));

            if (filteredLaptops.length === 0) {
                 const messageDiv = document.createElement('div');
                 messageDiv.className = "col-span-full text-center text-lg text-gray-500 p-8 rounded-lg bg-white shadow-inner";
                 messageDiv.textContent = "ไม่พบข้อมูลสำหรับตัวเลือกที่เลือกไว้";
                 laptopCardsContainer.appendChild(messageDiv);
                 return;
            }

            // Sort the filtered laptops based on the selected criteria.
            filteredLaptops.sort((a, b) => {
                let valueA, valueB;
                if (sortCriteria === 'price') {
                    valueA = a.prices.pro; // Sort by promo price as requested
                    valueB = b.prices.pro; // Sort by promo price as requested
                } else if (sortCriteria === 'cpuSpeed') {
                    valueA = a.cpu.ratings.singleNormal;
                    valueB = b.cpu.ratings.singleNormal;
                } else if (sortCriteria === 'cpuMulti') {
                    valueA = a.cpu.ratings.multiNormal;
                    valueB = b.cpu.ratings.multiNormal;
                } else if (sortCriteria === 'gpuRating') {
                    valueA = a.gpu.ratings.normal;
                    valueB = b.gpu.ratings.normal;
                }

                if (sortOrder === 'asc') {
                    return valueA - valueB;
                } else {
                    return valueB - valueA;
                }
            });

            // Get common properties if the checkbox is checked
            const commonProps = showDifferencesOnly ? getCommonProperties(filteredLaptops) : { cpu: new Set(), gpu: new Set(), ram: new Set(), ssd: new Set(), display: new Set() };
            
            // Generate and append the HTML for each laptop card.
            filteredLaptops.forEach(laptop => {
                const cpuRatingSingle = laptop.cpu.ratings.singleNormal;
                const cpuRatingMulti = laptop.cpu.ratings.multiNormal;
                const gpuRating = laptop.gpu.ratings.normal;
                const displayTypeRating = laptop.display.typeRating;
                const displayRating = laptop.display.rating;
                const displayHzRating = laptop.display.hzRating;
                const displayResolutionRating = laptop.display.resolutionRating;
                const displayBrightRating = laptop.display.brightRating;
                const displayColor = laptop.display.color;
                const displayColorRating = laptop.display.colorRating;
                const displayGamingRating = laptop.display.gamingRating;
                const dedicatedGpuId = laptop.gpu.dedicatedGpuId;
                const dedicatedGpuRating = laptop.gpu.dedicatedGpuRating;

                // ตรวจสอบว่าทั้งส่วนของสเปกนั้น ๆ เหมือนกันหรือไม่
                const isCpuSectionCommon = commonProps.cpu.has('id') && commonProps.cpu.has('architecture') && commonProps.cpu.has('releaseYear');
                const isGpuSectionCommon = commonProps.gpu.has('id') && commonProps.gpu.has('dedicatedGpuId');
                const isRamSectionCommon = commonProps.ram.has('value');
                const isSsdSectionCommon = commonProps.ssd.has('value');
                const isDisplaySectionCommon = commonProps.display.has('id') && commonProps.display.has('type') && commonProps.display.has('hz') && commonProps.display.has('resolution') && commonProps.display.has('bright') && commonProps.display.has('color');
                
                let gpuSectionHtml = '';
                // Check if a dedicated GPU exists and display a separate rating bar
                if (dedicatedGpuId !== 'N/A' && dedicatedGpuRating > 0) {
                    gpuSectionHtml = `
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-bold">GPU:</span>
                                <span>${dedicatedGpuId}</span>
                            </div>
                            <div class="space-y-1 pl-4">
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>การ์ดจอใน CPU:</span>
                                    <span class="font-bold text-gray-700">${laptop.gpu.id}</span>
                                </div>
                                ${createSegmentedRatingBar(gpuRating, 'gpuNormal')}
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>การ์ดจอแยก:</span>
                                    <span class="font-bold text-gray-700">${dedicatedGpuId}</span>
                                </div>
                                ${createSegmentedRatingBar(dedicatedGpuRating, 'gpuDedicated')}
                            </div>
                        </div>
                    `;
                } else {
                    // If no dedicated GPU, display a single bar for the integrated GPU
                    gpuSectionHtml = `
                        <div class="space-y-1">
                            <div class="flex justify-between items-center text-sm">
                                <span class="font-bold">GPU:</span>
                                <span>${laptop.gpu.id}</span>
                            </div>
                            <div class="pl-4">
                                <p class="text-xs text-gray-500">ประสิทธิภาพรวม</p>
                                ${createSegmentedRatingBar(gpuRating, 'gpuNormal')}
                            </div>
                        </div>
                    `;
                }

                // =================================================================
                // ส่วนของราคาโปรโมชั่นของคุณ
                // มีการเปลี่ยน onclick event เพื่อสลับการแสดงผลราคาเปรียบเทียบจากร้านอื่นทั้งหมด
                // =================================================================
                const myPriceHtml = `
                    <div class="p-4 bg-white rounded-xl shadow-lg mb-4 border-2 border-blue-400 price-toggle" onclick="toggleAllComparisonPrices()">
                        <div class="flex items-end">
                            <span class="text-4xl font-extrabold text-blue-600 mr-4">
                                ${laptop.prices.pro.toLocaleString()} บาท
                            </span>
                            <span class="text-lg text-gray-500 line-through">
                                ${laptop.prices.base.toLocaleString()} บาท
                            </span>
                        </div>
                        <!-- ซ่อนบรรทัดราคาเงินสดทั้งหมดถ้าไม่มีข้อมูล -->
                        ${laptop.prices.cash > 0 ? `
                        <p class="mt-2 text-sm text-gray-700">ราคาเงินสด: <span class="font-bold">${laptop.prices.cash.toLocaleString()} บาท</span></p>
                        ` : ''}
                    </div>
                `;

                // =================================================================
                // HTML สำหรับการแสดงราคาจากร้านค้าอื่น
                // เพิ่มคลาส `hidden` เพื่อซ่อนไว้ในตอนแรก
                // =================================================================
                const otherStoreDetailsHtml = `
                    <div class="store-details-section space-y-2 mt-4 text-sm bg-gray-50 p-4 rounded-lg hidden">
                        <p class="text-lg font-semibold text-gray-700 mb-2">ราคาเปรียบเทียบจากร้านอื่น</p>
                        ${(laptop.storePrices.advice > 0) ? `
                            <a href="${laptop.storeLinks.advice}" target="_blank" rel="noopener noreferrer" class="link-item hover:bg-gray-100 p-2 rounded-md">
                                <div class="flex items-center gap-2">
                                    <img src="${storeLogos.advice}" alt="Advice Logo" class="w-8 h-auto">
                                    <span>Advice:</span>
                                </div>
                                <span class="font-bold text-gray-900">${laptop.storePrices.advice.toLocaleString()} บาท</span>
                            </a>
                        ` : ''}
                        ${(laptop.storePrices.jib > 0) ? `
                            <a href="${laptop.storeLinks.jib}" target="_blank" rel="noopener noreferrer" class="link-item hover:bg-gray-100 p-2 rounded-md">
                                <div class="flex items-center gap-2">
                                    <img src="${storeLogos.jib}" alt="JIB Logo" class="w-8 h-auto">
                                    <span>JIB:</span>
                                </div>
                                <span class="font-bold text-gray-900">${laptop.storePrices.jib.toLocaleString()} บาท</span>
                            </a>
                        ` : ''}
                        ${(laptop.storePrices.bananait > 0) ? `
                            <a href="${laptop.storeLinks.bananait}" target="_blank" rel="noopener noreferrer" class="link-item hover:bg-gray-100 p-2 rounded-md">
                                <div class="flex items-center gap-2">
                                    <img src="${storeLogos.bananait}" alt="Banana IT Logo" class="w-8 h-auto">
                                    <span>Banana IT:</span>
                                </div>
                                <span class="font-bold text-gray-900">${laptop.storePrices.bananait.toLocaleString()} บาท</span>
                            </a>
                        ` : ''}
                    </div>
                `;
                
                // New logic for dimming all common properties based on the checkbox
                const isCpuIdCommon = commonProps.cpu.has('id');
                const isCpuArchCommon = commonProps.cpu.has('architecture');
                const isCpuYearCommon = commonProps.cpu.has('releaseYear');
                const isRamCommon = commonProps.ram.has('value');
                const isSsdCommon = commonProps.ssd.has('value');
                const isDisplayIdCommon = commonProps.display.has('id');
                const isDisplayTypeCommon = commonProps.display.has('type');
                const isDisplayHzCommon = commonProps.display.has('hz');
                const isDisplayResCommon = commonProps.display.has('resolution');
                const isDisplayBrightCommon = commonProps.display.has('bright');
                const isDisplayColorCommon = commonProps.display.has('color');


                const cardHtml = `
                    <div class="bg-white rounded-2xl shadow-xl flex flex-col space-y-2 laptop-card-main ${
                        laptop.isDisabled ? 'opacity-50 blur-[1px]' : ''
                    }">
                        <h2 class="text-xl font-bold text-gray-900 truncate">${laptop.model_id}</h2>

                        <div class="flex flex-col space-y-2 text-sm text-gray-700 mt-4">
                            <!-- CPU Section -->
                            <div class="spec-section-container ${isCpuSectionCommon ? 'is-common' : ''}" data-spec-type="cpu">
                                <div class="flex items-center justify-between text-sm">
                                    <span class="font-bold">CPU:</span>
                                    <span>${laptop.cpu.id}</span>
                                </div>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>สถาปัตยกรรม:</span>
                                    <span class="font-bold text-gray-700">${laptop.cpu.architecture}</span>
                                </div>
                                <div class="flex items-center justify-between text-xs text-gray-500">
                                    <span>ปีเปิดตัว:</span>
                                    <span class="font-bold text-gray-700">${laptop.cpu.releaseYear}</span>
                                </div>
                                <div class="space-y-1 pl-4">
                                    <p class="text-xs text-gray-500">ความเร็ว</p>
                                    ${createSegmentedRatingBar(cpuRatingSingle, 'cpuSpeed')}
                                    <p class="text-xs text-gray-500">ทำงานหลายอย่างพร้อมกัน</p>
                                    ${createSegmentedRatingBar(cpuRatingMulti, 'cpuMulti')}
                                </div>
                            </div>
                            <!-- GPU Section -->
                            <div class="spec-section-container ${isGpuSectionCommon ? 'is-common' : ''}" data-spec-type="gpu">
                                ${gpuSectionHtml}
                            </div>
                            <!-- RAM Section -->
                            <div class="spec-section-container ${isRamSectionCommon ? 'is-common' : ''}" data-spec-type="ram">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold">RAM:</span>
                                    <span>${laptop.ram.value}</span>
                                </div>
                                <div class="pl-4">
                                    ${createSegmentedRatingBar(laptop.ram.rating, 'ram')}
                                </div>
                            </div>
                            <!-- Storage Section -->
                            <div class="spec-section-container ${isSsdSectionCommon ? 'is-common' : ''}" data-spec-type="ssd">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold">Storage:</span>
                                    <span>${laptop.ssd.value}</span>
                                </div>
                                <div class="pl-4">
                                    ${createSegmentedRatingBar(laptop.ssd.rating, 'ssd')}
                                </div>
                            </div>
                            <!-- Display Section -->
                            <div class="spec-section-container display-toggle-section ${isDisplaySectionCommon ? 'is-common' : ''}" data-spec-type="display">
                                <div class="flex justify-between items-center text-sm">
                                    <span class="font-bold">Display:</span>
                                    <span>${laptop.display.id}</span>
                                </div>
                                <div class="space-y-1 pl-4">
                                    <p class="text-xs text-gray-500">ใช้งานทั่วไป</p>
                                    ${createSegmentedRatingBar(displayRating, 'displayGeneral')}
                                    <p class="text-xs text-gray-500">เล่นเกม</p>
                                    ${createSegmentedRatingBar(displayGamingRating, 'displayGaming')}

                                    <div class="detailed-display-section ${isDisplayDetailsShown ? '' : 'hidden'} space-y-1 pt-2">
                                        <div class="flex items-center justify-between text-xs">
                                            <span>ชนิดจอ:</span>
                                            <span class="font-bold text-gray-700">${laptop.display.type}</span>
                                        </div>
                                        ${createSegmentedRatingBar(displayTypeRating, 'displayType')}
                                        <div class="flex items-center justify-between text-xs">
                                            <span>ความละเอียด:</span>
                                            <span class="font-bold text-gray-700">${laptop.display.resolution}</span>
                                        </div>
                                        ${createSegmentedRatingBar(displayResolutionRating, 'displayResolution')}
                                        <div class="flex items-center justify-between text-xs">
                                            <span>Hz:</span>
                                            <span class="font-bold text-gray-700">${laptop.display.hz}</span>
                                        </div>
                                        ${createSegmentedRatingBar(displayHzRating, 'displayHz')}
                                        <div class="flex items-center justify-between text-xs">
                                            <span>ความสว่างจอ:</span>
                                            <span class="font-bold text-gray-700">${laptop.display.bright}</span>
                                        </div>
                                        ${createSegmentedRatingBar(displayBrightRating, 'displayBright')}
                                        <div class="flex items-center justify-between text-xs">
                                            <span>ขอบเขตสี (sRGB/DCI-P3):</span>
                                            <span class="font-bold text-gray-700">${displayColor}</span>
                                        </div>
                                        ${createSegmentedRatingBar(displayColorRating, 'displayColor')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ส่วนของราคาจะถูกย้ายมาไว้ด้านล่างนี้ -->
                        ${myPriceHtml}
                        ${otherStoreDetailsHtml}

                    </div>
                `;

                const cardDiv = document.createElement('div');
                cardDiv.innerHTML = cardHtml;
                const currentCard = cardDiv.firstElementChild;

                laptopCardsContainer.appendChild(currentCard);
            });

            // Attach click event listeners to all spec sections after they are rendered
            const allSpecSectionContainers = document.querySelectorAll('.spec-section-container');
            allSpecSectionContainers.forEach(container => {
                container.addEventListener('click', (event) => {
                    const clickedType = event.currentTarget.dataset.specType;

                    // New logic for the display section to toggle its local details
                    if (clickedType === 'display') {
                        // Toggle the global state and re-render cards to apply changes
                        toggleAllDisplayDetails();
                    } else {
                        // Keep the existing global highlight logic for other spec types
                        if (currentHighlightedSpecType === clickedType) {
                            clearGlobalHighlight();
                        } else {
                            highlightGlobalRating(clickedType);
                        }
                    }
                });
            });
        };

        // =================================================================
        // ส่วนที่ 4: ฟังก์ชันสำหรับจัดการ Event และ Logic
        // =================================================================
        
        /**
         * Function to toggle the visibility of the price comparison section for ALL cards.
         */
        const toggleAllComparisonPrices = () => {
            const comparisonSections = document.querySelectorAll('.store-details-section');
            comparisonSections.forEach(section => {
                section.classList.toggle('hidden');
            });
        };
        
        /**
         * Function to toggle the visibility of detailed display sections across all cards.
         * This is now a global toggle triggered by clicking any display section.
         */
        const toggleAllDisplayDetails = () => {
            isDisplayDetailsShown = !isDisplayDetailsShown;
            const detailedSections = document.querySelectorAll('.detailed-display-section');
            detailedSections.forEach(section => {
                if (isDisplayDetailsShown) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });
        };


        /**
         * Function to highlight a specific spec type across all cards.
         * @param {string} type - The data-spec-type of the section to highlight.
         */
        const highlightGlobalRating = (type) => {
            currentHighlightedSpecType = type;
            document.body.classList.add('global-dim-active');
            const allSpecSections = document.querySelectorAll('.spec-section-container');
            allSpecSections.forEach(section => {
                if (section.dataset.specType === type) {
                    section.classList.add('highlight-active');
                } else {
                    section.classList.remove('highlight-active');
                }
            });
        };

        /**
         * Function to clear all global highlights and dimming.
         */
        const clearGlobalHighlight = () => {
            currentHighlightedSpecType = null;
            document.body.classList.remove('global-dim-active');
            const allSpecSections = document.querySelectorAll('.spec-section-container');
            allSpecSections.forEach(section => {
                section.classList.remove('highlight-active');
            });
        };

        /**
         * Handles the click event for a model selection button.
         * @param {string} modelName - The name of the model that was clicked.
         */
        const handleModelClick = (modelName) => {
            const index = selectedModels.indexOf(modelName);
            if (index > -1) {
                // If already selected, remove it.
                selectedModels.splice(index, 1);
            } else {
                // If not selected and the count is less than 3, add it.
                if (selectedModels.length < 3) {
                    selectedModels.push(modelName);
                }
            }
            renderModelButtons(brandSelect.value, seriesSelect.value);
            renderSelectedLaptopsDisplay(); // Update the display of selected laptops
            renderLaptopCards();
            clearGlobalHighlight(); // Clear any active highlight when models change
        };

        /**
         * Updates the icon for the sort order button.
         */
        const updateSortOrderIcon = () => {
            if (sortOrder === 'asc') {
                sortIconUp.style.display = 'none';
                sortIconDown.style.display = 'block';
            } else {
                sortIconUp.style.display = 'block';
                sortIconDown.style.display = 'none';
            }
        };


        // Event Listeners for UI changes.
        brandSelect.addEventListener('change', (e) => {
            const brand = e.target.value;
            localStorage.setItem('selectedBrand', brand);
            localStorage.removeItem('selectedSeries');
            renderSeriesDropdown(brand);
            renderModelButtons(brand, seriesSelect.value);
            // selectedModels are intentionally NOT cleared here to persist selections
            renderSelectedLaptopsDisplay();
            renderLaptopCards();
            clearGlobalHighlight(); // Clear any active highlight when filters change
        });

        seriesSelect.addEventListener('change', (e) => {
            const series = e.target.value;
            localStorage.setItem('selectedSeries', series);
            renderModelButtons(brandSelect.value, series);
            // selectedModels are intentionally NOT cleared here to persist selections
            renderSelectedLaptopsDisplay();
            renderLaptopCards();
            clearGlobalHighlight(); // Clear any active highlight when filters change
        });

        sortBySelect.addEventListener('change', (e) => {
            sortCriteria = e.target.value;
            renderLaptopCards();
            clearGlobalHighlight(); // Clear any active highlight when sorting changes
        });

        sortOrderBtn.addEventListener('click', () => {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            updateSortOrderIcon();
            renderLaptopCards();
            clearGlobalHighlight(); // Clear any active highlight when sorting changes
        });
        
        showDiffCheckbox.addEventListener('change', (e) => {
            showDifferencesOnly = e.target.checked;
            renderLaptopCards();
        });


        // =================================================================
        // ส่วนที่ 5: เริ่มต้นการทำงานของแอปพลิเคชัน
        // =================================================================
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });
    </script>

</body>
</html>
